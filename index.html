<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Welders Helper</title>
  <meta name="theme-color" content="#101828" />
  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="apple-touch-icon" sizes="180x180" href="assets/icons/icon-180.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="assets/icons/icon-32.png" />
  <style>
    :root{--bg:#0b1120;--card:#111827;--border:#1f2937;--fg:#e5e7eb;--muted:#94a3b8;--accent:#22c55e}
    *{box-sizing:border-box}
    html,body{height:100%;margin:0}
    body{display:grid;place-items:center;background:var(--bg);color:var(--fg);
         font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;padding:24px}
    .card{width:min(560px,100%);background:var(--card);border:1px solid var(--border);
          border-radius:20px;padding:28px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    h1{margin:0 0 6px;font-size:28px;font-weight:800;letter-spacing:.2px}
    p{color:var(--muted);margin:8px 0 0}
    .row{display:flex;gap:10px;margin-top:16px;flex-wrap:wrap}
    .btn{appearance:none;border:0;border-radius:12px;padding:12px 16px;font-weight:700;cursor:pointer;background:#1f2937;color:var(--fg)}
    .btn.primary{background:var(--accent);color:#052e16}
    .badge{font-size:12px;margin-top:8px;color:var(--muted)}
    .instructions{margin-top:16px;font-size:14px;line-height:1.45;color:#cbd5e1}
    .instructions ul{margin:8px 0 0 18px;padding:0}
    .hidden{display:none !important}
    .icon-preview{display:block;width:64px;height:64px;border-radius:12px;margin:12px 0}
  </style>
</head>
<body>
  <main class="card" role="main" aria-label="Landing">
    <h1>Welders Helper</h1>
    <p>Install me once. Works offline. Tap <em>Enter</em> to continue.</p>
    <img class="icon-preview" src="assets/icons/icon-192.png" alt="App icon preview" />
    <div class="row">
      <button id="enterBtn" class="btn primary" onclick="location.href='app.html'">Enter</button>
      <button id="installBtn" class="btn" hidden>Install</button>
      <button id="checkBtn" class="btn">Check Offline</button>
    </div>
    <div id="status" class="badge"></div>

    <div id="instructions" class="instructions">
      <strong>Add <em>Welders Helper</em> to your Home Screen:</strong>
      <ul>
        <li><b>Android (Chrome)</b>: tap ⋮ (top-right) → <em>Add to Home screen</em></li>
        <li><b>iPhone/iPad (Safari)</b>: tap <em>Share</em> → <em>Add to Home Screen</em></li>
      </ul>
    </div>
  </main>

  <script>
    // SW auto-update + one-time reload when new SW takes control
    (async () => {
      if (!('serviceWorker' in navigator)) return;
      try {
        const reg = await navigator.serviceWorker.register('service_worker.js');

        // Ask for an immediate update check
        if (reg.update) reg.update();

        // Reload once when the updated SW activates
        navigator.serviceWorker.addEventListener('controllerchange', () => {
          if (!window.__reloadedOnce) {
            window.__reloadedOnce = true;    // prevent loops
            location.reload();
          }
        });

        document.getElementById('status').textContent = 'Offline ready.';
      } catch (e) {
        document.getElementById('status').textContent = 'Failed to register service worker.';
        console.error(e);
      }
    })();

    // Detect install readiness (Android prompt)
    let deferredPrompt=null;
    window.addEventListener('beforeinstallprompt', e => {
      e.preventDefault(); deferredPrompt=e; document.getElementById('installBtn').hidden=false;
    });
    document.getElementById('installBtn').addEventListener('click', async () => {
      document.getElementById('installBtn').hidden=true;
      if (!deferredPrompt) return;
      await deferredPrompt.prompt();
      await deferredPrompt.userChoice;
      localStorage.setItem('installed','1');
      hideInstructionsIfInstalled();
      deferredPrompt=null;
    });

    // iOS standalone or previously installed → hide instructions
    function hideInstructionsIfInstalled() {
      const standalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
      const flag = localStorage.getItem('installed') === '1';
      if (standalone || flag) {
        const el = document.getElementById('instructions');
        if (el) el.classList.add('hidden');
      }
    }
    hideInstructionsIfInstalled();

    // Offline check
    document.getElementById('checkBtn').addEventListener('click', async () => {
      try {
        const res = await caches.match(new Request('index.html', { cache: 'reload' }));
        document.getElementById('status').textContent = res ? '✅ Cached. Offline OK.' : '⚠️ Not cached yet.';
      } catch {
        document.getElementById('status').textContent = '⚠️ Not cached yet.';
      }
    });
  </script>
</body>
</html>
