<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>WELDERS HELPER — APP</title>
  <meta name="theme-color" content="#0A0F1A" />
  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="apple-touch-icon" sizes="180x180" href="assets/icons/icon-180.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="assets/icons/icon-32.png" />
  <style>
    :root{--bg:#0A0F1A;--card:#101826;--border:#223046;--fg:#E6EAF0;--muted:#8FA3BD;--accent:#26D07C}
    *{box-sizing:border-box} html,body{height:100%;margin:0}
    body{background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    header{position:sticky;top:0;background:#0C1320CC;backdrop-filter:blur(6px);border-bottom:1px solid var(--border);z-index:10}
    .nav{display:flex;gap:12px;align-items:center;padding:12px 16px;max-width:1080px;margin:0 auto}
    .brand{font-weight:900;letter-spacing:.02em}
    .pill{display:inline-block;padding:6px 10px;border-radius:999px;background:#0F172A;border:1px solid var(--border);font-size:12px;font-weight:900}
    .pill.ready{border-color:#155e3b;background:#0d1f17;color:#b7f7d2}
    main{max-width:1080px;margin:24px auto;padding:0 16px}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:14px}
    .tile{display:block;background:var(--card);border:1px solid var(--border);border-radius:16px;padding:18px 16px;text-decoration:none;color:var(--fg);font-weight:900;letter-spacing:.04em;text-transform:uppercase}
    .tile:hover{outline:2px solid var(--accent)}
    .sub{display:block;color:var(--muted);font-size:12px;margin-top:6px;text-transform:none}
    /* footer storage */
    footer{max-width:760px;margin:28px auto 18px auto;padding:0 16px;text-align:center}
    .storage-label{font-weight:900;letter-spacing:.06em;color:var(--muted);margin-bottom:8px}
    .storage-outer{width:min(520px,100%);margin:0 auto;border:1px solid #155e3b;background:#062815;border-radius:12px;height:18px;overflow:hidden}
    .storage-inner{height:100%;width:0%;background:#26D07C}
    .storage-meta{margin-top:6px;color:#b7f7d2;font-size:12px}
    .hidden{display:none!important}
  </style>
</head>
<body>
  <header>
    <nav class="nav">
      <a class="tile" href="index.html" style="padding:8px 12px;border-radius:10px">← HOME</a>
      <div class="brand">WELDERS HELPER</div>
      <div style="flex:1"></div>
      <span id="swBadge" class="pill">OFFLINE CHECKING…</span>
    </nav>
  </header>

  <main>
    <div class="grid">
      <a class="tile" href="jobs.html">Jobs
        <span class="sub">Create • Open • Export per job</span>
      </a>

      <!-- Keep Receiving tile commented out if you want job-first flow -->
      <!-- <a class="tile" href="receiving.html">Receiving Reports
        <span class="sub">Direct access</span>
      </a> -->

      <a class="tile" href="lookup.html">P# Lookup
        <span class="sub">Coming soon</span>
      </a>

      <a class="tile" href="#" onclick="alert('Inventory — coming soon');return false;">Inventory</a>
      <a class="tile" href="#" onclick="alert('Weld Maps — coming soon');return false;">Weld Maps</a>
      <a class="tile" href="#" onclick="alert('Settings — coming soon');return false;">Settings</a>
    </div>
  </main>

  <!-- FOOTER STORAGE BAR -->
  <footer>
    <div class="storage-label">STORAGE</div>
    <div class="storage-outer">
      <div id="storageInner" class="storage-inner"></div>
    </div>
    <div id="storageMeta" class="storage-meta">Calculating…</div>
  </footer>

  <script>
    /* ===== Offline badge (auto) ===== */
    const swBadge = document.getElementById('swBadge');
    function markReady() {
      swBadge.textContent = 'OFFLINE READY';
      swBadge.classList.add('ready');
    }
    (async () => {
      if (!('serviceWorker' in navigator)) { swBadge.textContent = 'NO SERVICE WORKER'; return; }
      try {
        const reg = await navigator.serviceWorker.register('service_worker.js');
        // immediately check for update and mark ready if controlled
        reg.update?.();
        if (navigator.serviceWorker.controller || reg.active) markReady();
        navigator.serviceWorker.addEventListener('controllerchange', markReady);
      } catch {
        swBadge.textContent = 'SW FAILED';
      }
    })();

    /* ===== Storage bar (auto-updates) ===== */
    const JOBS_KEY='wh_jobs_v1', RECV_KEY='wh_receiving_v1';
    const inner = document.getElementById('storageInner');
    const meta  = document.getElementById('storageMeta');

    function bToMB(n){ return (n/1024/1024).toFixed(1); }

    function roughSizeOfLocalData(){
      // Sum JSON length of our stores + base64 photo payloads
      let used = 0;
      const j = localStorage.getItem(JOBS_KEY)||'[]';
      const r = localStorage.getItem(RECV_KEY)||'[]';
      used += j.length + r.length;

      try {
        const rows = JSON.parse(r);
        for (const rec of rows) {
          for (const p of (rec.photos||[])) {
            const s = p?.dataUrl || '';
            const i = s.indexOf(',');
            if (i>0) used += Math.max(0, (s.length - i - 1)) * 3/4; // base64->bytes
          }
        }
      } catch {}
      return Math.round(used);
    }

    async function updateStorageBar(){
      try {
        const est = await navigator.storage?.estimate?.();
        const quota = est?.quota || 0;
        const usedCalc = roughSizeOfLocalData();
        // Some browsers include all site data (cache + storage) in estimate. Show both if present.
        const usedBrowser = est?.usage || 0;
        const used = Math.max(usedCalc, usedBrowser); // choose the bigger so bar never under-reports

        const pct = quota ? Math.min(100, Math.round((used / quota) * 100)) : 0;
        inner.style.width = pct + '%';
        meta.textContent = quota
          ? `${bToMB(used)} MB used / ${bToMB(quota)} MB (${pct}%)`
          : `${bToMB(used)} MB used`;
      } catch {
        const usedCalc = roughSizeOfLocalData();
        inner.style.width = '0%';
        meta.textContent = `${bToMB(usedCalc)} MB (estimate)`;
      }
    }

    // Update now and on common lifecycle events
    updateStorageBar();
    window.addEventListener('pageshow', updateStorageBar);
    document.addEventListener('visibilitychange', () => { if (!document.hidden) updateStorageBar(); });
    // When other pages finish actions they poke this key to trigger a storage event
    window.addEventListener('storage', (e) => { if (e.key === 'wh_last_change') updateStorageBar(); });
  </script>
</body>
</html>
