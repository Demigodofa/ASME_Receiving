let jobNumber;

window.onload = async () => {
    const params = new URLSearchParams(window.location.search);
    jobNumber = params.get("job");

    if (!jobNumber) {
        alert("Error: Job number missing.");
        window.location.href = "jobs.html";
        return;
    }

    loadJob();
    loadMaterials();

    document.getElementById("addMaterialBtn").onclick = () => {
        window.location.href = `add_material.html?job=${jobNumber}`;
    };

    document.getElementById("exportJobBtn").onclick = () => {
        exportJobData(jobNumber);
    };

    document.getElementById("deleteJobBtn").onclick = deleteJob;
};

async function loadJob() {
    const job = await db.jobs.where("jobNumber").equals(jobNumber).first();
    if (!job) return;

    document.getElementById("jobInfo").innerHTML = `
        <h2>Job #${job.jobNumber}</h2>
        <p>${job.description || ""}</p>
        <p>${job.notes || ""}</p>
    `;
}

async function loadMaterials() {
    const materials = await db.materials.where("jobNumber").equals(jobNumber).toArray();
    const container = document.getElementById("materialsList");
    container.innerHTML = "";

    materials.forEach((m) => {
        const div = document.createElement("div");
        div.className = "material-card";

        div.innerHTML = `
            <h3>${m.description}</h3>
            <button class="primary-btn" onclick="editMaterial('${m.id}')">Edit</button>
            <button class="danger-btn" onclick="deleteMaterial('${m.id}')">Delete</button>
        `;

        container.appendChild(div);
    });
}

function editMaterial(id) {
    window.location.href = `edit_material.html?id=${id}`;
}

async function deleteMaterial(id) {
    if (!confirm("Delete this material?")) return;
    await db.materials.delete(id);
    loadMaterials();
}

async function deleteJob() {
    if (!confirm(`Delete Job #${jobNumber}? This removes ALL materials.`)) return;

    await db.materials.where("jobNumber").equals(jobNumber).delete();
    await db.jobs.where("jobNumber").equals(jobNumber).delete();

    window.location.href = "jobs.html";
}
