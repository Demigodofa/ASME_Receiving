<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Job Details</title>

    <link rel="stylesheet" href="style.css">
    <link rel="manifest" href="manifest.webmanifest">

    <!-- iOS PWA -->
    <link rel="apple-touch-icon" sizes="180x180" href="assets/icons/icon-180.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">

    <script src="https://cdn.jsdelivr.net/npm/dexie@3/dist/dexie.min.js"></script>
</head>

<body>
<header class="header">
    <button class="back-btn" onclick="history.back()">‚Üê</button>
    <h1>Job Details</h1>
    <img src="assets/icons/icon-192.png" class="header-icon">
</header>

<main>
    <div class="card">
        <h2 id="jobNumberDisplay"></h2>

        <button class="primary-btn" onclick="window.location.href='add_material.html?job=' + jobNumber;">
            Add Material
        </button>
    </div>

    <!-- DARK BAR HEADER -->
    <div class="dark-header">
        RECEIVING INSPECTION REPORTS
    </div>

    <div id="materialsList"></div>
</main>

<script>
// ===============================
//   GET JOB NUMBER
// ===============================
const urlParams = new URLSearchParams(window.location.search);
const jobNumber = urlParams.get("job");

document.getElementById("jobNumberDisplay").textContent = "Job #" + jobNumber;

// ===============================
//   DEXIE SETUP
// ===============================
const db = new Dexie("WeldersHelperDB");
db.version(1).stores({
    jobs: "jobNumber, description",
    materials: "++id, jobNumber"
});

// ===============================
//   LOAD MATERIALS FOR JOB
// ===============================
async function loadMaterials() {
    const materials = await db.materials.where("jobNumber").equals(jobNumber).toArray();
    const container = document.getElementById("materialsList");
    container.innerHTML = "";

    if (materials.length === 0) {
        container.innerHTML = "<p style='text-align:center; color:#777;'>No receiving reports yet.</p>";
        return;
    }

    materials.forEach(mat => {
        const card = document.createElement("div");
        card.className = "card material-card";

        const spec = `${mat.specPrefix || ""}${mat.specPrefix && mat.specCode ? "-" : ""}${mat.specCode || ""}`;

        card.innerHTML = `
            <p><strong>Description:</strong> ${mat.description || ""}</p>
            <p><strong>Spec:</strong> ${spec}</p>
            <p><strong>Grade/Type:</strong> ${mat.gradeType || ""}</p>

            <button class="secondary-btn" style="margin-top:10px;"
                onclick="window.location.href='edit_material.html?id=${mat.id}&job=${jobNumber}'">
                Edit Material
            </button>
        `;

        container.appendChild(card);
    });
}

loadMaterials();
</script>

</body>
</html>
