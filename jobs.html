<!-- /ASME_Receiving/js/report_renderer.js -->
<script>
/* ===== Letter 8.5x11 portrait renderer (0.5" margins). NO PHOTOS on PDF. ===== */
async function renderLetterReportsNoPhotos(entries){
  const S=2, PT_W=612, PT_H=792, W=PT_W*S, H=PT_H*S, M=36*S; // 0.5" margin
  const pages=[]; for(const rec of entries){ pages.push(drawPage(W,H,M,S, norm(rec))); } return pages;
}
function drawPage(W,H,M,S,r){
  const c=document.createElement('canvas'); c.width=W; c.height=H; const g=c.getContext('2d'); g.imageSmoothingEnabled=false;
  const BOLD=px=>`bold ${Math.round(px*S)}px Arial`, REG=px=>`${Math.round(px*S)}px Arial`;
  const text=(t,x,y,px=11,b=false)=>{g.font=b?BOLD(px):REG(px); g.fillStyle='#000'; g.textBaseline='alphabetic'; g.fillText((t||'').toUpperCase(),x,y);};
  const box=(x,y,w,h)=>g.strokeRect(x,y,w,h); const hline=(x1,y,x2)=>{g.beginPath();g.moveTo(x1,y);g.lineTo(x2,y);g.stroke();};
  const vline=(x,y1,y2)=>{g.beginPath();g.moveTo(x,y1);g.lineTo(x,y2);g.stroke();};
  const wrap=(s,x,y,maxW,lh=13)=>{g.font=REG(11); g.fillStyle='#000'; let w='',yy=y; for(const wd of (s||'').toUpperCase().split(/\s+/)){const t=w?(w+' '+wd):wd;if(g.measureText(t).width>maxW){g.fillText(w,x,yy);yy+=lh*S;w=wd;}else w=t;} if(w) g.fillText(w,x,yy);};
  // page
  g.fillStyle='#FFF'; g.fillRect(0,0,W,H); g.strokeStyle='#000'; g.lineWidth=1*S;
  // title
  const TY=M+18*S; g.font=BOLD(16); const t='RECEIVING INSPECTION REPORT'; const tw=g.measureText(t).width; g.fillText(t,(W-tw)/2,TY); hline(M,TY+6*S,W-M);
  // IDENTIFICATION
  let y=TY+20*S; const secH=132*S; box(M,y,W-2*M,secH); text('IDENTIFICATION',M+8*S,y+18*S,12,true);
  const row=[y+28*S,y+28*S+44*S,y+28*S+88*S]; hline(M,row[0],W-M); hline(M,row[1],W-M); hline(M,row[2],W-M);
  const midX=M+(W-2*M)/2; vline(midX,y,y+secH);
  text('JOB NO.',M+10*S,row[0]-10*S,10,true); text(r.jobNo,M+110*S,row[0]-10*S);
  text('TITLE',M+10*S,row[1]-10*S,10,true); text(r.title,M+110*S,row[1]-10*S);
  text('VENDOR',M+10*S,row[2]-10*S,10,true); text(r.vendor,M+110*S,row[2]-10*S);
  const RX=midX+10*S; text('DATE',RX,row[0]-10*S,10,true); text(r.date,RX+90*S,row[0]-10*S);
  text('QUANTITY',RX,row[1]-10*S,10,true); text(r.qty,RX+90*S,row[1]-10*S);
  text('PO.',RX,row[2]-10*S,10,true); text(r.po,RX+90*S,row[2]-10*S);
  // SPECIFICATION
  y+=secH+14*S; const spH=96*S; box(M,y,W-2*M,spH); text('SPECIFICATION',M+8*S,y+18*S,12,true);
  const spRow=[y+28*S,y+28*S+48*S]; hline(M,spRow[0],W-M); hline(M,spRow[1],W-M); vline(midX,y,y+spH);
  text('PRODUCT',M+10*S,spRow[0]-10*S,10,true); text(r.product,M+110*S,spRow[0]-10*S);
  text('GRADE / TYPE',RX,spRow[0]-10*S,10,true); text(r.grade,RX+120*S,spRow[0]-10*S);
  text('SPEC',M+10*S,spRow[1]-10*S,10,true); text(`${r.specPrefix} ${r.specCode}`.trim(),M+110*S,spRow[1]-10*S);
  text('FITTING',RX,spRow[1]-10*S,10,true); text(r.fitting,RX+90*S,spRow[1]-10*S);
  // DIMENSIONS
  y+=spH+14*S; const dmH=114*S; box(M,y,W-2*M,dmH); text('DIMENSIONS',M+8*S,y+18*S,12,true);
  const thTop=y+28*S; hline(M,thTop,W-M); const gridTop=thTop+36*S; box(M,gridTop,W-2*M,dmH-(gridTop-y));
  const colW=(W-2*M)/3; const gridH=dmH-(gridTop-y); vline(M+colW,gridTop,gridTop+gridH); vline(M+2*colW,gridTop,gridTop+gridH); const dmMid=gridTop+gridH/2; hline(M,dmMid,W-M);
  text('TH',M+10*S,thTop-10*S,10,true); text((r.th||[]).filter(Boolean).join('   '),M+80*S,thTop-10*S);
  text('LENGTH',M+10*S,dmMid-10*S,10,true); text(r.length,M+98*S,dmMid-10*S);
  text('WIDTH',M+10*S+colW,dmMid-10*S,10,true); text(r.width,M+98*S+colW,dmMid-10*S);
  text('DIAMETER',M+10*S+2*colW,dmMid-10*S,10,true); text(r.diameter,M+120*S+2*colW,dmMid-10*S);
  text('OTHER',M+10*S,gridTop+gridH-10*S,10,true); text(r.dimOther,M+98*S,gridTop+gridH-10*S);
  text('O.D. / I.D.',M+10*S+2*colW,gridTop+gridH-10*S,10,true); text(r.diaType,M+120*S+2*colW,gridTop+gridH-10*S);
  // MARKINGS
  y+=dmH+14*S; const mkH=128*S; box(M,y,W-2*M,mkH); text('MARKINGS',M+8*S,y+18*S,12,true);
  const mk1=y+28*S, mk2=y+28*S+56*S, mk3=y+28*S+92*S; hline(M,mk1,W-M); hline(M,mk2,W-M); hline(M,mk3,W-M); vline(midX,y,y+mkH);
  text('ACTUAL MATERIAL MARKING',M+10*S,mk1-10*S,10,true); wrap(r.marking,M+220*S,mk1-24*S,(W-2*M)-240*S,13);
  text('MARKING OK',M+10*S,mk2-10*S,10,true); text(r.markingCode,M+140*S,mk2-10*S);
  text('MTR/COFC OK',midX+10*S,mk2-10*S,10,true); text(r.mtrOk,midX+150*S,mk2-10*S);
  // ACCEPTABILITY
  y+=mkH+14*S; const acH=98*S; box(M,y,W-2*M,acH); text('ACCEPTABILITY',M+8*S,y+18*S,12,true);
  const acTop=y+28*S, acMid=acTop+48*S; hline(M,acTop,W-M); hline(M,acMid,W-M); vline(M+colW,y,y+acH); vline(M+2*colW,y,y+acH);
  text('VISUAL',M+10*S,acTop-10*S,10,true); text(r.visualOk,M+98*S,acTop-10*S);
  text('B16 DIMENSIONS',M+10*S+colW,acTop-10*S,10,true); text(r.b16Ok,M+140*S+colW,acTop-10*S);
  text('DECISION',M+10*S+2*colW,acTop-10*S,10,true);
  const bxY=acTop-22*S; box(M+120*S+2*colW,bxY,14*S,14*S); text('ACCEPT',M+140*S+2*colW,acTop-10*S,10);
  box(M+210*S+2*colW,bxY,14*S,14*S); text('REJECT',M+230*S+2*colW,acTop-10*S,10);
  if((r.decision||'ACCEPT').toUpperCase()==='ACCEPT') text('X',M+123*S+2*colW,acTop-10*S); else text('X',M+213*S+2*colW,acTop-10*S);
  // COMMENTS row
  text('COMMENTS',M+10*S,acMid-10*S,10,true); wrap(r.comments,M+98*S,acMid-24*S,(W-2*M)-120*S,13);
  return c;
}
function norm(r){return{
  jobNo:r.jobNo||'',date:r.date||'',title:r.title||'',qty:r.qty||'',
  vendor:r.vendor||'',po:r.po||'',product:r.product||'',grade:r.grade||'',
  specPrefix:r.specPrefix||'',specCode:r.specCode||'',fitting:r.fitting||'',
  th:r.th||[],length:r.length||'',width:r.width||'',diameter:r.diameter||'',
  dimOther:r.dimOther||'',diaType:r.diaType||'',marking:r.marking||'',
  markingCode:r.markingCode||'',mtrOk:r.mtrOk||'',visualOk:r.visualOk||'',
  b16Ok:r.b16Ok||'',decision:r.decision||'ACCEPT',comments:r.comments||'',photos:r.photos||[]
};}
/* ===== minimal PDF: places each JPEG page onto Letter canvas ===== */
function buildPdfFromJpegs(jpegsU8, pageWpt=612, pageHpt=792){
  const parts=[], xref=[null]; let off=0; const enc=new TextEncoder();
  const add=b=>{parts.push(b); off+=b.length;}; const S=s=>add(enc.encode(s));
  S('%PDF-1.4\n'); xref[1]=off; S('1 0 obj\n<< /Type /Catalog /Pages 2 0 R >>\nendobj\n');
  xref[2]=off; S('2 0 obj\n<< /Type /Pages /Count ' + jpegsU8.length + ' /Kids [ ');
  let id=3; const kids=[]; for(let i=0;i<jpegsU8.length;i++){ kids.push(id+2); id+=3; }
  S(kids.map(n=>`${n} 0 R `).join('')); S('] >>\nendobj\n'); id=3;
  for(let i=0;i<jpegsU8.length;i++){ const imgId=id++, contId=id++, pageId=id++; const img=jpegsU8[i];
    xref[imgId]=off; S(`${imgId} 0 obj\n<< /Type /XObject /Subtype /Image /Filter /DCTDecode /ColorSpace /DeviceRGB /BitsPerComponent 8 /Width ${pageWpt} /Height ${pageHpt} /Length ${img.length} >>\nstream\n`); add(img); S('\nendstream\nendobj\n');
    const content=`q\n${pageWpt} 0 0 ${pageHpt} 0 0 cm\n/Im${i} Do\nQ\n`;
    xref[contId]=off; S(`${contId} 0 obj\n<< /Length ${content.length} >>\nstream\n${content}\nendstream\nendobj\n`);
    xref[pageId]=off; S(`${pageId} 0 obj\n<< /Type /Page /Parent 2 0 R /MediaBox [0 0 ${pageWpt} ${pageHpt}] /Resources << /XObject << /Im${i} ${imgId} 0 R >> >> /Contents ${contId} 0 R >>\nendobj\n`);
  }
  const xrefStart=off; S(`xref\n0 ${xref.length}\n0000000000 65535 f \n`); for(let i=1;i<xref.length;i++){ const p=String(xref[i]||0).padStart(10,'0'); S(`${p} 00000 n \n`); }
  S(`trailer\n<< /Size ${xref.length} /Root 1 0 R >>\nstartxref\n${xrefStart}\n%%EOF`); return new Blob(parts,{type:'application/pdf'});
}
/* ===== utils used by jobs.html ===== */
function dataURLtoU8(d){const i=d.indexOf(',');const b=atob(d.slice(i+1));const u=new Uint8Array(b.length);for(let k=0;k<b.length;k++)u[k]=b.charCodeAt(k);return u;}
function loadImage(src){return new Promise(r=>{const im=new Image();im.onload=()=>r(im);im.src=src;});}
async function compressDataUrlToJpegU8(dataUrl,maxDim=1600,quality=0.85){const img=await loadImage(dataUrl);const sc=Math.min(1,maxDim/Math.max(img.width,img.height));const w=Math.max(1,Math.round(img.width*sc)),h=Math.max(1,Math.round(img.height*sc));const c=document.createElement('canvas');c.width=w;c.height=h;c.getContext('2d').drawImage(img,0,0,w,h);const out=c.toDataURL('image/jpeg',quality);return {u8:dataURLtoU8(out)};}
function saveBlobSmart(name, blob){const url=URL.createObjectURL(blob);if(/iPad|iPhone|iPod/.test(navigator.userAgent)){window.open(url,'_blank');}else{const a=document.createElement('a');a.href=url;a.download=name;a.click();}setTimeout(()=>URL.revokeObjectURL(url),30000);}
function sanitize(s){return (s||'').toUpperCase().replace(/[^A-Z0-9\-_. /]/g,'_').replace(/\s+/g,'-');}
function zipStoreCompat(files){const enc=new TextEncoder(),LE2=n=>new Uint8Array([n&255,(n>>>8)&255]),LE4=n=>new Uint8Array([n&255,(n>>>8)&255,(n>>>16)&255,(n>>>24)&255]);const cat=arrs=>{let l=0;for(const a of arrs)l+=a.length;const o=new Uint8Array(l);let p=0;for(const a of arrs){o.set(a,p);p+=a.length;}return o;};const crc32=u8=>{let c=~0>>>0;for(let i=0;i<u8.length;i++){c^=u8[i];for(let k=0;k<8;k++)c=(c>>>1)^(0xEDB88320&-(c&1));}return (~c)>>>0;};const now=new Date();const dosTime=((now.getHours()&31)<<11)|((now.getMinutes()&63)<<5)|((now.getSeconds()/2)&31);const dosDate=(((now.getFullYear()-1980)&127)<<9)|(((now.getMonth()+1)&15)<<5)|(now.getDate()&31);const norm=files.map(f=>({name:sanitize((f.name||'').replace(/\\/g,'/')),dir:!!f.dir,data:f.data?(f.data instanceof Uint8Array?f.data:new Uint8Array(f.data)):new Uint8Array()}));const locals=[],centrals=[];let offs=0;for(const f of norm){const n=enc.encode(f.name);const dir=f.dir||f.name.endsWith('/');const data=dir?new Uint8Array():f.data;const crc=dir?0:crc32(data);const size=data.length;const local=cat([enc.encode('PK\x03\x04'),LE2(20),LE2(0),LE2(0),LE2(dosTime),LE2(dosDate),LE4(crc),LE4(size),LE4(size),LE2(n.length),LE2(0),n]);locals.push(local,data);const central=cat([enc.encode('PK\x01\x02'),LE2(20),LE2(20),LE2(0),LE2(0),LE2(dosTime),LE2(dosDate),LE4(crc),LE4(size),LE4(size),LE2(n.length),LE2(0),LE2(0),LE2(dir?0x10:0),LE2(0),LE4(dir?0x10:0),LE4(offs),n]);centrals.push(central);offs+=local.length+data.length;}const L=cat(locals),C=cat(centrals),E=cat([enc.encode('PK\x05\x06'),LE2(0),LE2(0),LE2(norm.length),LE2(norm.length),LE4(C.length),LE4(L.length),LE2(0)]);return new Blob([L,C,E],{type:'application/zip'});}
</script>

<!-- /ASME_Receiving/jobs.html (export button handler only – keep rest of your file) -->
<script>
/* Export current job with PDF (no photos in PDF) + photos as JPG → ZIP */
async function exportJobToZipNoPhotos(jobNo){
  const JOBS_KEY='wh_jobs_v1', RECV_KEY='wh_receiving_v1';
  const jobs=JSON.parse(localStorage.getItem(JOBS_KEY)||'[]'); const job=jobs.find(j=>j.jobNo===jobNo); if(!job){alert('JOB NOT FOUND');return;}
  const entries=(JSON.parse(localStorage.getItem(RECV_KEY)||'[]')).filter(r=>r.jobNo===jobNo);
  if(!entries.length){alert('NO RECEIVING ENTRIES FOR THIS JOB');return;}

  // 1) PDF (letter portrait, 0.5" margin) — NO PHOTOS SECTION
  const canvases = await renderLetterReportsNoPhotos(entries);
  const jpegU8s  = canvases.map(c => dataURLtoU8(c.toDataURL('image/jpeg', 0.92)));
  const pdfBlob  = buildPdfFromJpegs(jpegU8s, 612, 792);
  const pdfU8    = new Uint8Array(await pdfBlob.arrayBuffer());

  // 2) Photos into /PHOTOS/*.jpg (scaled for size)
  const files = [];
  const base = `${sanitize(job.jobNo)}_${sanitize(job.desc||'')}`.replace(/_$/,'');
  files.push({ name: `${base}-REPORT.pdf`, data: pdfU8 });
  files.push({ name: 'PHOTOS/', dir: true });

  for(const r of entries){
    const title = sanitize(r.title || 'ITEM');
    for(let i=0;i<(r.photos||[]).length;i++){
      const { u8 } = await compressDataUrlToJpegU8(r.photos[i].dataUrl, 1600, 0.85);
      files.push({ name: `PHOTOS/${sanitize(r.jobNo)}-${title} (${i+1}).jpg`, data: u8 });
    }
  }

  // 3) ZIP → save to device (Android ➜ Downloads; iOS ➜ Share sheet)
  const zipBlob = zipStoreCompat(files);
  saveBlobSmart(`${base}-DOCS.zip`, zipBlob);
}

/* Example: wire your existing button */
document.addEventListener('click', (e)=>{
  const btn=e.target.closest('#exportBtn'); if(!btn) return;
  e.preventDefault();
  const jobNo = (window.current && window.current.jobNo) || (btn.dataset.jobno); // adapt if needed
  exportJobToZipNoPhotos(jobNo);
});
</script>
