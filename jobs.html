<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>WELDERS HELPER — JOBS</title>
<meta name="theme-color" content="#0A0F1A" />
<link rel="manifest" href="manifest.webmanifest" />
<style>
  :root{--bg:#0A0F1A;--panel:#101826;--border:#223046;--fg:#E6EAF0;--muted:#8FA3BD;--accent:#26D07C;--danger:#FF5A5F;--focus:#8AB4F8}
  *{box-sizing:border-box} html,body{height:100%;margin:0}
  body{background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;letter-spacing:.02em}
  header{position:sticky;top:0;background:#0C1320CC;backdrop-filter:blur(6px);border-bottom:1px solid var(--border)}
  .nav{display:flex;gap:12px;align-items:center;padding:12px 16px;max-width:1120px;margin:0 auto}
  .brand{font-weight:900}
  .btn{border:1px solid var(--border);background:#0F172A;color:#E6EAF0;padding:10px 14px;border-radius:12px;font-weight:900;letter-spacing:.04em;text-transform:uppercase;cursor:pointer;text-decoration:none}
  .btn.primary{background:var(--accent);color:#052e16;border-color:#1B9E64}
  .btn.danger{background:var(--danger);border-color:#D83A3F}
  .btn:focus{outline:3px solid var(--focus);outline-offset:2px}
  main{max-width:1120px;margin:24px auto;padding:0 16px}
  .card{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:16px;margin-bottom:16px}
  label{font-size:12px;color:var(--muted);font-weight:800;display:block;margin-bottom:6px}
  input{width:100%;padding:12px 12px;border-radius:12px;border:1px solid var(--border);background:#0D1424;color:#E6EAF0;text-transform:uppercase;font-weight:800}
  .row{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px}
  .pill{display:inline-block;padding:4px 10px;border-radius:999px;background:#0F172A;border:1px solid var(--border);font-size:12px;font-weight:800}
  table{width:100%;border-collapse:collapse}
  th,td{border-bottom:1px solid var(--border);padding:14px 10px}
  th{font-size:11px;color:#8FA3BD;text-transform:uppercase;letter-spacing:.06em}
  .empty{color:var(--muted);text-align:center;padding:18px;text-transform:uppercase}
  .badge{display:inline-block;min-width:1.6em;text-align:center;padding:2px 6px;border-radius:999px;border:1px solid var(--border);background:#0F172A;font-weight:900;font-size:12px}
  .badge.zero{opacity:.5}
  .btn.hasReports{color:#26D07C}

  /* Overlay — centered, but hidden by default */
.overlay{
  position:fixed; inset:0; background:rgba(0,0,0,.5);
  z-index:50; padding:16px;
  min-height:100svh;
  display:none;               /* <-- keep ONLY this display */
  align-items:center; justify-content:center; /* used when JS sets display:flex */
}
  .sheet{
    width:min(480px,92vw); max-height:88svh; overflow:auto;
    background:var(--panel); border:1px solid var(--border);
    border-radius:18px; padding:18px; box-shadow:0 20px 60px rgba(0,0,0,.45);
  }
  .sheet h2{margin:0 0 6px 0;font-size:20px;text-transform:uppercase}
  .meta{color:#E6EAF0;font-size:20px;font-weight:900;letter-spacing:.06em;margin:2px 0 10px 0;word-break:break-word}
  .stack{display:flex;flex-direction:column;gap:10px;align-items:center}
  .wide{width:100%;text-align:center}
  .confirm{display:none;margin-top:10px;text-align:center}
  .confirm .rowc{display:flex;gap:10px;justify-content:center;margin-top:10px}
  .small{font-size:12px;color:#8FA3BD}
  .ok{color:#b7f7d2}
  .warn{color:#ffd6d6}
  .progress{height:6px;border-radius:999px;background:#0b1f15;border:1px solid #1B9E64;overflow:hidden;width:100%;display:none}
  .progress > div{height:100%;width:0%;background:#26D07C;transition:width .12s linear}
</style>
</head>
<body>
<header>
  <nav class="nav">
    <a class="btn" href="app.html">← APP</a>
    <div class="brand">JOBS</div>
    <div style="flex:1"></div>
  </nav>
</header>

<main>
  <section class="card">
    <div class="row">
      <div><label for="jobNo">JOB NO. (MAX 8) *</label><input id="jobNo" maxlength="8" /></div>
      <div><label for="desc">DESC. (MAX 12)</label><input id="desc" maxlength="12" /></div>
      <div><label for="startDate">START DATE</label><input id="startDate" type="date" /></div>
    </div>
    <div style="display:flex;gap:12px;margin-top:12px;flex-wrap:wrap">
      <button id="createBtn" class="btn primary">CREATE JOB</button>
      <button id="clearBtn" class="btn">CLEAR</button>
    </div>
  </section>

  <section class="card">
    <table>
      <thead><tr><th>JOB</th><th>DESC</th><th>START</th><th>CREATED</th><th>REPORTS</th></tr></thead>
      <tbody id="jobsBody"><tr><td colspan="5" class="empty">NO JOBS YET</td></tr></tbody>
    </table>
    <div class="small">TIP: TAP A ROW FOR ACTIONS</div>
  </section>
</main>

<!-- ACTION MENU -->
<div id="overlay" class="overlay" role="dialog" aria-modal="true">
  <div class="sheet" role="document">
    <h2>JOB ACTIONS</h2>
    <div id="dlgMeta" class="meta">JOB — DESC</div>

    <div class="progress" id="exportProg"><div></div></div>
    <div id="zipNote" class="small" style="min-height:1.2em"></div>

    <div class="stack" style="margin-top:8px">
      <a id="viewBtn" class="btn primary wide" href="#">VIEW JOB</a>
      <button id="exportBtn" class="btn wide">EXPORT REPORTS</button>
      <button id="deleteBtn" class="btn danger wide">DELETE JOB</button>
      <button id="closeBtn" class="btn wide">CLOSE</button>

      <div id="confirmBox" class="confirm">
        <div>ARE YOU SURE YOU WANT TO DELETE THIS JOB?</div>
        <div class="rowc">
          <button id="yesDel" class="btn danger">YES</button>
          <button id="noDel" class="btn">NO</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
/* ============================ STORAGE ============================ */
const JOBS_KEY='wh_jobs_v1', RECV_KEY='wh_receiving_v1';
const $=id=>document.getElementById(id);
const safeRead=(k)=>{ try{const s=localStorage.getItem(k);return s?JSON.parse(s):[]}catch{ return []} };
const safeWrite=(k,v)=>{ try{localStorage.setItem(k,JSON.stringify(v)); localStorage.setItem('wh_last_change', String(Date.now()));}catch{} };
const readJobs=()=>safeRead(JOBS_KEY);
const writeJobs=(a)=>safeWrite(JOBS_KEY,a);
const readRecv=()=>safeRead(RECV_KEY);
const writeRecv=(a)=>safeWrite(RECV_KEY,a);
const today=()=>new Date().toISOString().slice(0,10);
const sanitize=s=>(s||'').toUpperCase().replace(/[^A-Z0-9\-_. /]/g,'_').replace(/\s+/g,'-');

/* ============================ UI: LIST =========================== */
function countReports(jobNo){ return readRecv().filter(r=>r.jobNo===jobNo).length; }

function renderJobs(){
  const rows=readJobs().sort((a,b)=>b.createdAt.localeCompare(a.createdAt));
  const tb=$('jobsBody'); tb.innerHTML='';
  if(!rows.length){tb.innerHTML='<tr><td colspan="5" class="empty">NO JOBS YET</td></tr>';return;}
  for(const j of rows){
    const n=countReports(j.jobNo);
    const tr=document.createElement('tr'); tr.className='jobrow'; tr.dataset.job=j.jobNo;
    tr.innerHTML=`<td><span class="pill">${j.jobNo}</span></td>
      <td>${(j.desc||'').toUpperCase()}</td>
      <td>${j.startDate||''}</td>
      <td>${new Date(j.createdAt).toLocaleString().toUpperCase()}</td>
      <td><span class="badge ${n? '' : 'zero'}">${n}</span></td>`;
    tb.appendChild(tr);
  }
}
$('jobsBody').onclick=(e)=>{const tr=e.target.closest('tr.jobrow'); if(tr) openMenu(tr.dataset.job);};

/* ============================ CREATE ============================ */
$('createBtn').onclick=()=>{
  const jobNo=$('jobNo').value.trim().toUpperCase();
  const desc=$('desc').value.trim().toUpperCase();
  const start=$('startDate').value || today();
  if(!jobNo) return alert('JOB NO. REQUIRED');
  if(jobNo.length>8) return alert('JOB NO. MUST BE ≤ 8');
  if(readJobs().some(j=>j.jobNo===jobNo)) return alert('JOB NO. ALREADY EXISTS');
  const now=new Date().toISOString();
  const id=(crypto.randomUUID&&crypto.randomUUID())||Math.random().toString(36).slice(2);
  const jobs=readJobs(); jobs.unshift({id,jobNo,desc,startDate:start,createdAt:now}); writeJobs(jobs);
  $('jobNo').value=''; $('desc').value=''; $('startDate').value=today();
  renderJobs();
};
$('clearBtn').onclick=()=>{$('jobNo').value='';$('desc').value='';};

/* ============================ ACTIONS (never stuck) ============== */
let current=null;
function openMenu(jobNo){
  const job=readJobs().find(j=>j.jobNo===jobNo); if(!job) return;
  current=job; $('dlgMeta').textContent=`${job.jobNo} — ${(job.desc||'')}`;
  $('viewBtn').href=`job.html?job=${encodeURIComponent(job.jobNo)}`;
  $('confirmBox').style.display='none'; $('zipNote').textContent='';
  const hasReports = countReports(job.jobNo) > 0;
  $('exportBtn').classList.toggle('hasReports', hasReports);
  $('overlay').style.display='flex'; $('closeBtn').focus();
}
function closeMenu(){ $('overlay').style.display='none'; current=null; }
$('closeBtn').onclick=closeMenu;
$('overlay').addEventListener('click',(e)=>{ if(e.target===e.currentTarget) closeMenu(); });
document.addEventListener('keydown',(e)=>{ if(e.key==='Escape' && $('overlay').style.display!=='none') closeMenu(); });

/* DELETE JOB */
$('deleteBtn').onclick=()=>{ $('confirmBox').style.display='block'; };
$('noDel').onclick =()=>{ $('confirmBox').style.display='none'; };
$('yesDel').onclick=()=>{
  if(!current) return;
  writeJobs(readJobs().filter(j=>j.jobNo!==current.jobNo));
  writeRecv(readRecv().filter(r=>r.jobNo!==current.jobNo));
  current=null; renderJobs(); closeMenu();
};

/* ============================ EXPORT ============================ */
$('exportBtn').onclick = async (ev) => {
  ev.preventDefault();
  if (!current) return;

  const disable = (on)=>{ ['exportBtn','deleteBtn','viewBtn','closeBtn'].forEach(id=>{ const el=$(id); if(el) el.disabled=on; }); };
  const entries = readRecv().filter(r => r.jobNo === current.jobNo);
  if (!entries.length) { alert('NO RECEIVING ENTRIES FOR THIS JOB'); return; }

  const setNote = (msg, cls='') => { const n=$('zipNote'); n.textContent=msg; n.className='small '+cls; };
  const progWrap = $('exportProg'), progBar = progWrap.firstElementChild;
  const setProg = (pct) => { progWrap.style.display='block'; progBar.style.width = Math.max(0, Math.min(100, pct)) + '%'; };
  const tick = () => new Promise(r=>setTimeout(r,0));

  const MAX_EXPORT_PHOTOS = 12;   // higher cap, we will compress if needed
  let photoAdded = 0;

  try{
    disable(true);
    setNote('BUILDING PDF…'); setProg(10);

    // 1) Render pages (150dpi)
    const canvases = await renderReceivingPdfPages(entries);
    await tick();

    // 2) JPEG pages
    const pages=[]; 
    for (let i=0;i<canvases.length;i++){
      const c = canvases[i];
      pages.push({ u8: dataURLtoU8(c.toDataURL('image/jpeg', 0.92)), w: c.width, h: c.height });
      setProg(10 + Math.round(((i+1)/canvases.length)*25)); // → 35%
      await tick();
    }

    // 3) Build PDF
    const pdfBlob = buildPdfFromJpegsExact(pages, 612, 792);
    const pdfU8    = new Uint8Array(await pdfBlob.arrayBuffer());
    setProg(40); setNote('ADDING PHOTOS…');

    // 4) Photos into ZIP
    const base = `${sanitize(current.jobNo)}_${sanitize(current.desc||'')}`.replace(/_$/,'');
    const files = [{ name:`${base}-REPORTS.pdf`, data: pdfU8 }, { name:'PHOTOS/', dir:true }];

    let done=0, total=0;
    entries.forEach(r=>{ total += Math.min(MAX_EXPORT_PHOTOS, (r.photos||[]).length); });

    for (const r of entries) {
      const title = sanitize(r.title || 'ITEM');
      const photos = (r.photos || []).slice(0, MAX_EXPORT_PHOTOS);

      for (let i = 0; i < photos.length; i++) {
        try {
          const {u8, ext} = await getPhotoBytes(photos[i]); // tolerant loader
          files.push({ name:`PHOTOS/${sanitize(r.jobNo)}-${title} (${i+1}).${ext}`, data: u8 });
          photoAdded++;
        } catch (err) {
          console.warn('Photo skipped:', err);
        }
        done++;
        setProg(40 + Math.round((done/Math.max(1,total))*45)); // → 85%
        await tick();
      }
    }

    setNote(photoAdded ? `ZIPPING… (${photoAdded} photos)` : 'ZIPPING… (no photos found)');
    setProg(88);
    const zipBlob = zipStoreCompat(files);

    setNote('SAVING…'); setProg(95);
    const ok = await saveSmartZip(base, zipBlob);

    if (ok) { setProg(100); setNote(`EXPORTED. ${photoAdded} PHOTOS INCLUDED. CHECK DOWNLOADS / FILES.`, 'ok'); }
    else {
      const url = URL.createObjectURL(pdfBlob);
      window.open(url, '_blank');
      setNote('COULD NOT SAVE ZIP. OPENED PDF IN A NEW TAB.', 'warn');
      setProg(100);
      setTimeout(()=>URL.revokeObjectURL(url), 30000);
    }
  } catch(e){
    console.error(e);
    setNote('EXPORT FAILED. SEE CONSOLE LOGS.', 'warn'); 
  } finally {
    // Never leave the UI frozen
    disable(false);
  }
};

/* ---------- Photo loader: accept many shapes; prefer originals ----- */
async function getPhotoBytes(photo){
  // Returns {u8: Uint8Array, ext: 'jpg'|'png'}
  if (!photo) throw new Error('empty photo');

  // Raw string (data URL)
  if (typeof photo === 'string') return dataUrlToBytes(photo);

  // Common fields
  const durl = photo.dataUrl || photo.dataURL || photo.src || photo.url;
  if (typeof durl === 'string') return dataUrlToBytes(durl);

  // Blob/File
  const blob = photo.blob || photo.file;
  if (blob instanceof Blob) return blobToPreferred(blob);

  // Raw bytes
  const bytes = photo.bytes || photo.data;
  if (bytes instanceof Uint8Array) return {u8: bytes, ext: 'jpg'}; // assume jpg if unknown
  if (bytes instanceof ArrayBuffer) return {u8: new Uint8Array(bytes), ext: 'jpg'};

  throw new Error('unsupported photo shape');
}

function dataUrlToBytes(durl){
  if (!durl.startsWith('data:')) throw new Error('not a dataURL');
  const mime = durl.slice(5, durl.indexOf(';')) || 'image/jpeg';
  const i = durl.indexOf(',');
  const bin = atob(durl.slice(i+1));
  const u8 = new Uint8Array(bin.length);
  for (let k=0;k<bin.length;k++) u8[k]=bin.charCodeAt(k);

  // Keep JPEG/PNG as-is; convert others to JPEG for PC-friendliness
  if (mime.includes('jpeg') || mime.includes('jpg')) return {u8, ext:'jpg'};
  if (mime.includes('png'))  return {u8, ext:'png'};
  // HEIC/WEBP/etc -> convert
  return {u8: null, ext: 'jpg', _convertFrom: durl};
}

async function blobToPreferred(blob){
  const mime = blob.type || 'image/jpeg';
  const buf = await blob.arrayBuffer();
  const u8 = new Uint8Array(buf);
  if (mime.includes('jpeg') || mime.includes('jpg')) return {u8, ext:'jpg'};
  if (mime.includes('png'))  return {u8, ext:'png'};
  // Convert others to JPEG
  const durl = URL.createObjectURL(blob);
  try {
    const jpeg = await toJpegBytesFromUrl(durl, 1280, 0.82);
    return {u8: jpeg, ext:'jpg'};
  } finally {
    URL.revokeObjectURL(durl);
  }
}

async function toJpegBytesFromUrl(url, maxDim=1280, quality=0.82){
  const img = await new Promise((res,rej)=>{ const im=new Image(); im.onload=()=>res(im); im.onerror=rej; im.src=url; });
  const s = Math.min(1, maxDim/Math.max(img.width,img.height));
  const W = Math.max(1, Math.round(img.width*s)), H = Math.max(1, Math.round(img.height*s));
  const c=document.createElement('canvas'); c.width=W; c.height=H; c.getContext('2d').drawImage(img,0,0,W,H);
  const durl = c.toDataURL('image/jpeg', quality);
  const i=durl.indexOf(','), bin=atob(durl.slice(i+1)); const u8=new Uint8Array(bin.length);
  for(let k=0;k<bin.length;k++) u8[k]=bin.charCodeAt(k);
  return u8;
}

/* ---------- PDF RENDER (Letter portrait, 0.5" margins) ---------- */
async function renderReceivingPdfPages(entries){
  const W=1275, H=1650, M=75; // 150dpi
  const pages=[];
  for(const raw of entries){
    const r = norm(raw);
    const c=document.createElement('canvas'); c.width=W; c.height=H;
    const g=c.getContext('2d'); g.fillStyle='#fff'; g.fillRect(0,0,W,H);
    g.strokeStyle='#000'; g.lineWidth=1;

    const B=(px)=>`bold ${px}px Arial`; const R=(px)=>`${px}px Arial`;
    const text=(s,x,y,px=14,b=false)=>{ g.font=b?B(px):R(px); g.fillStyle='#000'; g.textBaseline='alphabetic'; g.fillText((s||'').toUpperCase(),x,y); };
    const box =(x,y,w,h)=>g.strokeRect(x,y,w,h);
    const hln =(x1,y,x2)=>{ g.beginPath(); g.moveTo(x1,y); g.lineTo(x2,y); g.stroke(); };
    const vln =(x,y1,y2)=>{ g.beginPath(); g.moveTo(x,y1); g.lineTo(x,y2); g.stroke(); };
    const wrap=(s,x,y,maxW,lh=18,px=14)=>{ g.font=R(px); let line='',yy=y; (s||'').toUpperCase().split(/\s+/).forEach(w=>{
      const t=line? line+' '+w:w; if(g.measureText(t).width>maxW){ g.fillText(line,x,yy); yy+=lh; line=w; } else line=t;
    }); if(line) g.fillText(line,x,yy); };

    text('RECEIVING REPORTS', M, M+22, 22, true);
    hln(M, M+28, W-M);

    let y=M+40;
    text('IDENTIFICATION', M+6, y+18, 14, true);
    const IDH=124; box(M,y+24,W-2*M,IDH);
    const rw=IDH/3, midX=M+(W-2*M)/2;
    hln(M, y+24+rw, W-M); hln(M, y+24+2*rw, W-M); vln(midX, y+24, y+24+IDH);
    text('JOB NO.',   M+12, y+24+rw-8, 12, true); text(r.jobNo,   M+120, y+24+rw-8);
    text('DATE',     midX+12, y+24+rw-8, 12, true); text(r.date, midX+100, y+24+rw-8);
    text('TITLE',    M+12, y+24+2*rw-8, 12, true); text(r.title,   M+120, y+24+2*rw-8);
    text('QUANTITY', midX+12, y+24+2*rw-8, 12, true); text(r.qty,  midX+120, y+24+2*rw-8);
    text('VENDOR',   M+12, y+24+3*rw-8, 12, true); text(r.vendor,  M+120, y+24+3*rw-8);
    text('PO.',      midX+12, y+24+3*rw-8, 12, true); text(r.po,   midX+100, y+24+3*rw-8);

    y += 24+IDH+16;
    text('SPECIFICATION', M+6, y+18, 14, true);
    const SPH=92; box(M,y+24,W-2*M,SPH);
    const spRw=SPH/2; const spMid=midX;
    hln(M, y+24+spRw, W-M); vln(spMid, y+24, y+24+SPH);
    text('PRODUCT', M+12, y+24+spRw-8, 12, true); text(r.product, M+120, y+24+spRw-8);
    text('GRADE / TYPE', spMid+12, y+24+spRw-8, 12, true); text(r.grade, spMid+140, y+24+spRw-8);
    text('SPEC', M+12, y+24+2*spRw-8, 12, true); text(`${r.specPrefix} ${r.specCode}`, M+120, y+24+2*spRw-8);
    text('FITTING', spMid+12, y+24+2*spRw-8, 12, true); text(r.fitting, spMid+120, y+24+2*spRw-8);

    y += 24+SPH+16;
    text('DIMENSIONS', M+6, y+18, 14, true);
    const DMH=108; box(M,y+24,W-2*M,DMH);
    const dmRw=DMH/3;
    hln(M, y+24+dmRw, W-M); hln(M, y+24+2*dmRw, W-M);
    text('TH', M+12, y+24+dmRw-8, 12, true);
    text((r.th||[]).filter(Boolean).join('   '), M+70, y+24+dmRw-8);
    text('LENGTH', M+12, y+24+2*dmRw-8, 12, true); text(r.length, M+120, y+24+2*dmRw-8);
    text('WIDTH',  midX+12, y+24+2*dmRw-8, 12, true); text(r.width,  midX+100, y+24+2*dmRw-8);
    text('DIAMETER', M+12, y+24+3*dmRw-8, 12, true); text(`${r.diameter} ${r.diaType}`.trim(), M+120, y+24+3*dmRw-8);
    text('OTHER',    midX+12, y+24+3*dmRw-8, 12, true); text(r.dimOther, midX+100, y+24+3*dmRw-8);

    y += 24+DMH+16;
    text('MARKINGS', M+6, y+18, 14, true);
    const MKH=128; box(M,y+24,W-2*M,MKH);
    const mkRw=MKH/3;
    hln(M, y+24+mkRw, W-M); hln(M, y+24+2*mkRw, W-M);
    text('ACTUAL MATERIAL MARKING', M+12, y+24+mkRw-10, 12, true);
    wrap(r.marking, M+12, y+24+mkRw+4, W-2*M-24, 18, 14);
    text('MARKING ACCEPTABLE TO CODE/STANDARD', M+12, y+24+2*mkRw-8, 12, true);
    text(r.markingCode, M+360, y+24+2*mkRw-8);
    text('MTR/COFC ACCEPTABLE TO SPECIFICATION', M+12, y+24+3*mkRw-8, 12, true);
    text(r.mtrOk, M+360, y+24+3*mkRw-8);

    y += 24+MKH+16;
    text('ACCEPTABILITY', M+6, y+18, 14, true);
    const ACH=98; box(M,y+24,W-2*M,ACH);
    const acRw=ACH/2; hln(M, y+24+acRw, W-M);
    text('VISUAL', M+12, y+24+acRw-8, 12, true); text(r.visualOk, M+120, y+24+acRw-8);
    text('B16 DIMENSIONS', midX+12, y+24+acRw-8, 12, true); text(r.b16Ok, midX+180, y+24+acRw-8);

    text('DECISION', M+12, y+24+2*acRw-8, 12, true);
    const bxY=y+24+2*acRw-22;
    g.strokeRect(M+120, bxY, 18, 18); g.fillText('ACCEPT', M+146, y+24+2*acRw-8);
    g.strokeRect(M+240, bxY, 18, 18); g.fillText('REJECT', M+266, y+24+2*acRw-8);
    if((r.decision||'ACCEPT')==='ACCEPT'){ g.font=B(14); g.fillText('X', M+124, y+24+2*acRw-8); }
    else { g.font=B(14); g.fillText('X', M+244, y+24+2*acRw-8); }

    const midX=M+(W-2*M)/2;
    g.font=B(12); g.fillText('COMMENTS', midX+12, y+24+2*acRw-8);
    wrap(r.comments, midX+120, y+24+2*acRw-22, (W-2*M)-(midX-M)-20, 18, 14);

    y += 24+ACH+16;
    g.strokeRect(M,y,W-2*M,44);
    g.font=B(12);
    g.fillText('MATERIAL APPROVAL  APPROVED', M+12, y+28);
    g.fillText('QC MANAGER  INITIALS / DATE', midX+12, y+28);

    pages.push(c);
  }
  return pages;

  function norm(r){
    return {
      jobNo:(r.jobNo||''), date:(r.date||''), title:(r.title||''), qty:(r.qty||''),
      vendor:(r.vendor||''), po:(r.po||''), product:(r.product||''), grade:(r.grade||''),
      specPrefix:(r.specPrefix||''), specCode:(r.specCode||''), fitting:(r.fitting||''),
      th:(r.th||[]), length:(r.length||''), width:(r.width||''), diameter:(r.diameter||''),
      dimOther:(r.dimOther||''), diaType:(r.diaType||''), marking:(r.marking||''),
      markingCode:(r.markingCode||''), mtrOk:(r.mtrOk||''), visualOk:(r.visualOk||''),
      b16Ok:(r.b16Ok||''), decision:(r.decision||'ACCEPT'), comments:(r.comments||''),
      photos:(r.photos||[])
    };
  }
}

/* ----------------------- PDF & ZIP utils ------------------------ */
function dataURLtoU8(d){ const i=d.indexOf(','); const bin=atob(d.slice(i+1)); const u8=new Uint8Array(bin.length); for(let k=0;k<bin.length;k++) u8[k]=bin.charCodeAt(k); return u8; }

function buildPdfFromJpegsExact(pages, pageWpt=612, pageHpt=792){
  const parts=[]; const enc=new TextEncoder(); let offset=0; const xref=[null];
  const addS=s=>{const u8=enc.encode(s); parts.push(u8); offset+=u8.length;};
  const addU8=u8=>{parts.push(u8); offset+=u8.length;};
  const obj=(id,body)=>{ xref[id]=offset; addS(`${id} 0 obj\n${body}\nendobj\n`); };

  addS('%PDF-1.4\n');
  obj(1, `<< /Type /Catalog /Pages 2 0 R >>`);
  obj(2, `<< /Type /Pages /Count ${pages.length} /Kids [ ${pages.map((_,i)=>`${3+i*3+2} 0 R`).join(' ')} ] >>`);

  pages.forEach((pg,i)=>{
    const imgId=3+i*3, cntId=4+i*3, pageId=5+i*3;

    xref[imgId]=offset;
    addS(`${imgId} 0 obj\n<< /Type /XObject /Subtype /Image /Filter /DCTDecode /ColorSpace /DeviceRGB /BitsPerComponent 8 /Width ${pg.w} /Height ${pg.h} /Length ${pg.u8.length} >>\nstream\n`);
    addU8(pg.u8); addS(`\nendstream\nendobj\n`);

    const content=`q
${pageWpt} 0 0 ${pageHpt} 0 0 cm
/Im${i} Do
Q
`;
    obj(cntId, `<< /Length ${content.length} >>\nstream\n${content}\nendstream`);

    obj(pageId, `<< /Type /Page /Parent 2 0 R /MediaBox [0 0 ${pageWpt} ${pageHpt}] /Resources << /XObject << /Im${i} ${imgId} 0 R >> >> /Contents ${cntId} 0 R >>`);
  });

  const startXref=offset;
  addS(`xref\n0 ${xref.length}\n0000000000 65535 f \n`);
  for(let i=1;i<xref.length;i++) addS(`${String(xref[i]).padStart(10,'0')} 00000 n \n`);
  addS(`trailer\n<< /Size ${xref.length} /Root 1 0 R >>\nstartxref\n${startXref}\n%%EOF`);
  return new Blob(parts,{type:'application/pdf'});
}

function zipStoreCompat(files) {
  const enc = new TextEncoder(), LE2=n=>new Uint8Array([n&255,(n>>>8)&255]), LE4=n=>new Uint8Array([n&255,(n>>>8)&255,(n>>>16)&255,(n>>>24)&255]);
  const join = arrs => { let L=0; for(const a of arrs) L+=a.length; const out=new Uint8Array(L); let o=0; for(const a of arrs){ out.set(a,o); o+=a.length; } return out; };
  const crc32=u8=>{ let c=~0>>>0; for(let i=0;i<u8.length;i++){ c^=u8[i]; for(let k=0;k<8;k++) c=(c>>>1)^(0xEDB88320&-(c&1)); } return (~c)>>>0; };
  const now=new Date(); const dosTime=((now.getHours()&31)<<11)|((now.getMinutes()&63)<<5)|((now.getSeconds()/2)&31);
  const dosDate=(((now.getFullYear()-1980)&127)<<9)|(((now.getMonth()+1)&15)<<5)|(now.getDate()&31);
  const norm = files.map(f=>({ name:sanitize((f.name||'').replace(/\\/g,'/')), dir:!!f.dir, data:f.data? (f.data instanceof Uint8Array?f.data:new Uint8Array(f.data)):new Uint8Array() }));
  const locals=[], centrals=[]; let offset=0;
  for(const f of norm){
    const name=enc.encode(f.name), isDir=f.dir||f.name.endsWith('/'), data=isDir?new Uint8Array():f.data, crc=isDir?0:crc32(data), size=data.length;
    const local=join([enc.encode('PK\x03\x04'),LE2(20),LE2(0),LE2(0),LE2(dosTime),LE2(dosDate),LE4(crc),LE4(size),LE4(size),LE2(name.length),LE2(0),name]);
    locals.push(local,data);
    const central=join([enc.encode('PK\x01\x02'),LE2(20),LE2(20),LE2(0),LE2(0),LE2(dosTime),LE2(dosDate),LE4(crc),LE4(size),LE4(size),LE2(name.length),LE2(0),LE2(0),LE2(isDir?0x10:0),LE2(0),LE4(isDir?0x10:0),LE4(offset),name]);
    centrals.push(central); offset += local.length + data.length;
  }
  const localsAll=join(locals), centralsAll=join(centrals);
  const end=join([enc.encode('PK\x05\x06'),LE2(0),LE2(0),LE2(norm.length),LE2(norm.length),LE4(centralsAll.length),LE4(localsAll.length),LE2(0)]);
  return new Blob([localsAll, centralsAll, end], {type:'application/zip'});
}

async function saveWithPicker(fileName, blob, mime='application/zip', ext='.zip') {
  if (!('showSaveFilePicker' in window)) return false;
  try {
    const handle = await showSaveFilePicker({
      suggestedName: fileName,
      types: [{ description: 'Archive', accept: { [mime]: [ext] } }],
      excludeAcceptAllOption: false
    });
    const w = await handle.createWritable(); await w.write(blob); await w.close(); return true;
  } catch { return false; }
}
async function shareFile(fileName, blob, mime='application/zip') {
  try { const file = new File([blob], fileName, { type: mime });
    if (navigator.canShare && navigator.canShare({ files: [file] })) {
      await navigator.share({ files: [file], title: fileName, text: 'WELDERS HELPER EXPORT' }); return true;
    }
  } catch {}
  return false;
}
function downloadViaAnchor(fileName, blob) {
  try { const url = URL.createObjectURL(blob); const a=document.createElement('a');
    a.href=url; a.download=fileName; document.body.appendChild(a); a.click();
    setTimeout(()=>{ document.body.removeChild(a); URL.revokeObjectURL(url); }, 1500); return true;
  } catch { return false; }
}
async function saveSmartZip(baseName, zipBlob) {
  const fileName = `${baseName}-DOCS.zip`;
  if (await saveWithPicker(fileName, zipBlob)) return true;
  if (await shareFile(fileName, zipBlob)) return true;
  if (downloadViaAnchor(fileName, zipBlob)) return true;
  return false;
}

/* ============================ INIT ============================== */
function initJobsPage(){
  const sd = document.getElementById('startDate');
  if (sd && !sd.value) sd.value = today();
  renderJobs();
}
initJobsPage();
window.addEventListener('pageshow', initJobsPage);
window.addEventListener('storage', (e)=>{ if (e.key === JOBS_KEY || e.key===RECV_KEY) renderJobs(); });

/* -------- Service Worker: update now + reload once on upgrade ---- */
(async () => {
  if (!('serviceWorker' in navigator)) return;
  try {
    const reg = await navigator.serviceWorker.register('service_worker.js');
    reg.update?.();
    navigator.serviceWorker.addEventListener('controllerchange', () => {
      if (!window.__swReloadOnce) { window.__swReloadOnce = true; location.reload(); }
    });
  } catch (e) { console.error('SW registration failed', e); }
})();
</script>
</body>
</html>
