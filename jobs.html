<!-- /ASME_Receiving/jobs.html  — drop-in replacement -->
<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>WELDERS HELPER — JOBS</title>
<meta name="theme-color" content="#0A0F1A" />
<link rel="manifest" href="manifest.webmanifest" />
<style>
  :root{--bg:#0A0F1A;--panel:#101826;--border:#223046;--fg:#E6EAF0;--muted:#8FA3BD;--accent:#26D07C;--danger:#FF5A5F;--focus:#8AB4F8}
  *{box-sizing:border-box} html,body{height:100%;margin:0}
  body{background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;letter-spacing:.02em}
  header{position:sticky;top:0;background:#0C1320CC;backdrop-filter:blur(6px);border-bottom:1px solid var(--border)}
  .nav{display:flex;gap:12px;align-items:center;padding:12px 16px;max-width:1120px;margin:0 auto}
  .brand{font-weight:900}
  .btn{border:1px solid var(--border);background:#0F172A;color:#E6EAF0;padding:10px 14px;border-radius:12px;font-weight:900;letter-spacing:.04em;text-transform:uppercase;cursor:pointer;text-decoration:none}
  .btn.primary{background:var(--accent);color:#052e16;border-color:#1B9E64}
  .btn.danger{background:var(--danger);border-color:#D83A3F}
  .btn:focus{outline:3px solid var(--focus);outline-offset:2px}
  main{max-width:1120px;margin:24px auto;padding:0 16px}
  .card{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:16px;margin-bottom:16px}
  label{font-size:12px;color:var(--muted);font-weight:800;display:block;margin-bottom:6px}
  input{width:100%;padding:12px 12px;border-radius:12px;border:1px solid var(--border);background:#0D1424;color:#E6EAF0;text-transform:uppercase;font-weight:800}
  .row{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px}
  .pill{display:inline-block;padding:4px 10px;border-radius:999px;background:#0F172A;border:1px solid var(--border);font-size:12px;font-weight:800}
  table{width:100%;border-collapse:collapse} th,td{border-bottom:1px solid var(--border);padding:14px 10px} th{font-size:11px;color:#8FA3BD;text-transform:uppercase;letter-spacing:.06em}
  .empty{color:var(--muted);text-align:center;padding:18px;text-transform:uppercase}
  .overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:50}
  .sheet{width:min(620px,92%);background:var(--panel);border:1px solid var(--border);border-radius:18px;padding:18px;box-shadow:0 20px 60px rgba(0,0,0,.45)}
  .sheet h2{margin:0 0 6px 0;font-size:20px;text-transform:uppercase}
  .meta{color:#E6EAF0;font-size:22px;font-weight:900;letter-spacing:.06em;margin:2px 0 12px 0}
  .stack{display:flex;flex-direction:column;gap:10px;align-items:center}
  .wide{width:100%;text-align:center}
  .confirm{display:none;margin-top:10px;text-align:center}
  .confirm .rowc{display:flex;gap:10px;justify-content:center;margin-top:10px}
  .small{font-size:12px;color:#8FA3BD}
</style>
</head>
<body>
<header>
  <nav class="nav">
    <a class="btn" href="app.html">← APP</a>
    <div class="brand">JOBS</div>
    <div style="flex:1"></div>
    <span class="pill">OFFLINE READY</span>
  </nav>
</header>

<main>
  <!-- Create -->
  <section class="card">
    <div class="row">
      <div><label for="jobNo">JOB NO. (MAX 8) *</label><input id="jobNo" maxlength="8" /></div>
      <div><label for="desc">DESC. (MAX 12)</label><input id="desc" maxlength="12" /></div>
      <div><label for="startDate">START DATE</label><input id="startDate" type="date" /></div>
    </div>
    <div style="display:flex;gap:12px;margin-top:12px;flex-wrap:wrap">
      <button id="createBtn" class="btn primary">CREATE JOB</button>
      <button id="clearBtn" class="btn">CLEAR</button>
    </div>
  </section>

  <!-- List -->
  <section class="card">
    <table>
      <thead><tr><th>JOB</th><th>DESC</th><th>START</th><th>CREATED</th></tr></thead>
      <tbody id="jobsBody"><tr><td colspan="4" class="empty">NO JOBS YET</td></tr></tbody>
    </table>
    <div class="small">TIP: TAP A ROW FOR ACTIONS</div>
  </section>
</main>

<!-- ACTION MENU -->
<div id="overlay" class="overlay" role="dialog" aria-modal="true">
  <div class="sheet">
    <h2>JOB ACTIONS</h2>
    <div id="dlgMeta" class="meta">JOB — DESC</div>
    <div class="stack">
      <a id="viewBtn" class="btn primary wide" href="#">VIEW JOB</a>
      <button id="exportBtn" class="btn wide">EXPORT REPORTS</button>
      <button id="deleteBtn" class="btn danger wide">DELETE JOB</button>
      <button id="closeBtn" class="btn wide">CLOSE</button>
      <div id="confirmBox" class="confirm">
        <div>ARE YOU SURE YOU WANT TO DELETE THIS JOB?</div>
        <div class="rowc">
          <button id="yesDel" class="btn danger">YES</button>
          <button id="noDel" class="btn">NO</button>
        </div>
      </div>
      <div id="zipNote" class="small"></div>
    </div>
  </div>
</div>

<script>
/* ===== storage & helpers ===== */
const JOBS_KEY='wh_jobs_v1', RECV_KEY='wh_receiving_v1';
const $=id=>document.getElementById(id);
const readJobs=()=>JSON.parse(localStorage.getItem(JOBS_KEY)||'[]');
const writeJobs=a=>localStorage.setItem(JOBS_KEY,JSON.stringify(a));
const readRecv=()=>JSON.parse(localStorage.getItem(RECV_KEY)||'[]');
const today=()=>new Date().toISOString().slice(0,10);
function sanitize(s){ return (s||'').toUpperCase().replace(/[^A-Z0-9\-_. /]/g,'_').replace(/\s+/g,'-'); }
function dataURLtoU8(d){ const i=d.indexOf(','); const bin=atob(d.slice(i+1)); const u8=new Uint8Array(bin.length); for(let k=0;k<bin.length;k++) u8[k]=bin.charCodeAt(k); return u8; }
function blobToU8(blob){ return new Promise(r=>{ const fr=new FileReader(); fr.onload=()=>r(new Uint8Array(fr.result)); fr.readAsArrayBuffer(blob); }); }
function saveBlobSmart(name, blob){
  const url = URL.createObjectURL(blob);
  if (/iPad|iPhone|iPod/.test(navigator.userAgent)) { window.open(url, '_blank'); }
  else { const a=document.createElement('a'); a.href=url; a.download=name; a.click(); }
  setTimeout(()=>URL.revokeObjectURL(url), 30000);
}

/* ===== list & create ===== */
function renderJobs(){
  const rows=readJobs().sort((a,b)=>b.createdAt.localeCompare(a.createdAt));
  const tb=$('jobsBody'); tb.innerHTML='';
  if(!rows.length){tb.innerHTML='<tr><td colspan="4" class="empty">NO JOBS YET</td></tr>';return;}
  for(const j of rows){
    const tr=document.createElement('tr'); tr.className='jobrow'; tr.dataset.job=j.jobNo;
    tr.innerHTML=`<td><span class="pill">${j.jobNo}</span></td>
      <td>${(j.desc||'').toUpperCase()}</td>
      <td>${j.startDate||''}</td>
      <td>${new Date(j.createdAt).toLocaleString().toUpperCase()}</td>`;
    tb.appendChild(tr);
  }
}
$('jobsBody').onclick=(e)=>{const tr=e.target.closest('tr.jobrow'); if(tr) openMenu(tr.dataset.job);};

$('createBtn').onclick=()=>{
  const jobNo=$('jobNo').value.trim().toUpperCase();
  const desc=$('desc').value.trim().toUpperCase();
  const start=$('startDate').value || today();
  if(!jobNo) return alert('JOB NO. REQUIRED');
  if(jobNo.length>8) return alert('JOB NO. MUST BE ≤ 8');
  if(readJobs().some(j=>j.jobNo===jobNo)) return alert('JOB NO. ALREADY EXISTS');
  const now=new Date().toISOString();
  const id=(crypto.randomUUID&&crypto.randomUUID())||Math.random().toString(36).slice(2);
  const jobs=readJobs(); jobs.unshift({id,jobNo,desc,startDate:start,createdAt:now}); writeJobs(jobs);
  $('jobNo').value=''; $('desc').value=''; $('startDate').value=today(); renderJobs();
};
$('clearBtn').onclick=()=>{$('jobNo').value='';$('desc').value='';};

/* ===== action menu ===== */
let current=null;
function openMenu(jobNo){
  const job=readJobs().find(j=>j.jobNo===jobNo); if(!job) return;
  current=job; $('dlgMeta').textContent=`${job.jobNo} — ${(job.desc||'')}`;
  $('viewBtn').href=`job.html?job=${encodeURIComponent(job.jobNo)}`;
  $('confirmBox').style.display='none'; $('zipNote').textContent='';
  $('overlay').style.display='flex'; $('closeBtn').focus();
}
function closeMenu(){ $('overlay').style.display='none'; current=null; }
$('closeBtn').onclick=closeMenu;
$('overlay').onclick=(e)=>{ if(e.target===e.currentTarget) closeMenu(); };

/* ===== EXPORT: portrait PDF (official grid) + photos in ZIP ===== */
$('exportBtn').onclick = async (ev) => {
  ev.preventDefault();
  if (!current) return;
  const entries = readRecv().filter(r => r.jobNo === current.jobNo);
  if (!entries.length) { alert('NO RECEIVING ENTRIES FOR THIS JOB'); return; }

  const canvases = await renderOfficialFormPages(entries);        // <- new layout
  const jpegU8s  = canvases.map(c => dataURLtoU8(c.toDataURL('image/jpeg', 0.92)));
  const pdfBlob  = buildPdfFromJpegs(jpegU8s, 612, 792);
  const pdfU8    = await blobToU8(pdfBlob);

  const base = `${sanitize(current.jobNo)}_${sanitize(current.desc||'')}`.replace(/_$/,'');
  const maxDim = 1600, quality = 0.85;
  const photoFiles = [{ name:'PHOTOS/', dir:true }];              // directory entry

  for (const r of entries) {
    const title = sanitize(r.title || 'ITEM');
    for (let i = 0; i < (r.photos || []).length; i++) {
      const p = r.photos[i];
      const { u8 } = await compressDataUrlToJpegU8(p.dataUrl, maxDim, quality);
      photoFiles.push({ name:`PHOTOS/${sanitize(r.jobNo)}-${title} (${i+1}).jpg`, data:u8 });
    }
  }

  const files = [{ name:`${base}-REPORT.pdf`, data: pdfU8 }, ...photoFiles];
  const zipBlob = zipStoreCompat(files);
  saveBlobSmart(`${base}-DOCS.zip`, zipBlob);
};

/* ===== CANVAS RENDERER — “official” form (portrait) ===== */
async function renderOfficialFormPages(rows){
  const W=1275, H=1650, M=54;            // 150dpi Letter portrait-ish
  const pages=[];
  for(const rec of rows){ const r=norm(rec);
    const c=document.createElement('canvas'); c.width=W; c.height=H; const g=c.getContext('2d');
    g.fillStyle='#FFFFFF'; g.fillRect(0,0,W,H); g.strokeStyle='#000'; g.lineWidth=1;

    const bold=(px)=>`bold ${px}px Arial`; const reg=(px)=>`${px}px Arial`;
    const cap=(t,x,y)=>{g.font=bold(20); g.fillStyle='#000'; g.fillText(t,x,y);};
    const lab=(t,x,y)=>{g.font=bold(14); g.fillText(t,x,y);};
    const val=(t,x,y)=>{g.font=reg(14); g.fillText((t||'').toUpperCase(),x,y);};
    const box=(x,y,w,h)=>{g.strokeRect(x,y,w,h);};
    const grid=(x,y,w,h,rows,cols)=>{box(x,y,w,h); const rw=h/rows, cw=w/cols;
      for(let i=1;i<rows;i++){g.beginPath(); g.moveTo(x,y+rw*i); g.lineTo(x+w,y+rw*i); g.stroke();}
      for(let j=1;j<cols;j++){g.beginPath(); g.moveTo(x+cw*j,y); g.lineTo(x+cw*j,y+h); g.stroke();}
      return {rw,cw};
    };

    // Title
    g.font=bold(26); g.fillText('RECEIVING INSPECTION REPORT', M, M+6);
    g.beginPath(); g.moveTo(M, M+14); g.lineTo(W-M, M+14); g.stroke();

    // IDENTIFICATION
    const IDY=M+32; cap('IDENTIFICATION', M+8, IDY+22);
    const id = grid(M, IDY+28, W-2*M, 120, 3, 4);
    lab('JOB NO.',   M+10, IDY+50); val(r.jobNo, M+120, IDY+50);
    lab('DATE',      M+10+ (W-2*M)/4, IDY+50); val(r.date, M+120+ (W-2*M)/4, IDY+50);
    lab('TITLE',     M+10, IDY+50+id.rw); val(r.title, M+120, IDY+50+id.rw);
    lab('QUANTITY',  M+10+ (W-2*M)/4, IDY+50+id.rw); val(r.qty, M+120+ (W-2*M)/4, IDY+50+id.rw);
    lab('VENDOR',    M+10, IDY+50+id.rw*2); val(r.vendor, M+120, IDY+50+id.rw*2);
    lab('PO.',       M+10+ (W-2*M)/4, IDY+50+id.rw*2); val(r.po, M+120+ (W-2*M)/4, IDY+50+id.rw*2);

    // SPECIFICATION
    const SPY=IDY+28+120+18; cap('SPECIFICATION', M+8, SPY+22);
    const sp = grid(M, SPY+28, W-2*M, 90, 2, 4);
    lab('PRODUCT', M+10, SPY+50);  val(r.product, M+120, SPY+50);
    lab('GRADE / TYPE', M+10+(W-2*M)/2, SPY+50); val(r.grade, M+140+(W-2*M)/2, SPY+50);
    lab('SPEC', M+10, SPY+50+sp.rw); val(`${r.specPrefix} ${r.specCode}`, M+120, SPY+50+sp.rw);
    lab('FITTING', M+10+(W-2*M)/2, SPY+50+sp.rw); val(r.fitting, M+120+(W-2*M)/2, SPY+50+sp.rw);

    // DIMENSIONS
    const DY=SPY+28+90+18; cap('DIMENSIONS', M+8, DY+22);
    const dTop = grid(M, DY+28, W-2*M, 36, 1, 1);
    lab('TH', M+10, DY+50);
    val((r.th||[]).filter(Boolean).join('   '), M+80, DY+50);

    const d2Y = DY+28+36;
    const d2 = grid(M, d2Y, W-2*M, 72, 2, 3);
    lab('LENGTH', M+10, d2Y+22);  val(r.length, M+120, d2Y+22);
    lab('WIDTH',  M+10+(W-2*M)/3, d2Y+22); val(r.width,  M+110+(W-2*M)/3, d2Y+22);
    lab('DIAMETER', M+10+2*(W-2*M)/3, d2Y+22); val(r.diameter, M+120+2*(W-2*M)/3, d2Y+22);
    lab('OTHER', M+10, d2Y+22+d2.rw); val(r.dimOther, M+120, d2Y+22+d2.rw);
    lab('O.D./I.D.', M+10+2*(W-2*M)/3, d2Y+22+d2.rw); val(r.diaType, M+120+2*(W-2*M)/3, d2Y+22+d2.rw);

    // MARKINGS
    const MKY=d2Y+72+18; cap('MARKINGS', M+8, MKY+22);
    const mk = grid(M, MKY+28, W-2*M, 112, 3, 2);
    lab('ACTUAL MATERIAL\nMARKING', M+10, MKY+50); wrap(g, r.marking, M+240, MKY+38, W-2*M-260, 18);
    lab('MARKING OK', M+10, MKY+50+mk.rw); val(r.markingCode, M+140, MKY+50+mk.rw);
    lab('MTR/COFC OK', M+10+(W-2*M)/2, MKY+50+mk.rw); val(r.mtrOk, M+150+(W-2*M)/2, MKY+50+mk.rw);

    // ACCEPTABILITY
    const ACY=MKY+28+112+18; cap('ACCEPTABILITY', M+8, ACY+22);
    const ac = grid(M, ACY+28, W-2*M, 96, 2, 3);
    lab('VISUAL', M+10, ACY+50); val(r.visualOk, M+120, ACY+50);
    lab('B16 DIMENSIONS', M+10+(W-2*M)/3, ACY+50); val(r.b16Ok, M+200+(W-2*M)/3, ACY+50);
    lab('DECISION', M+10+2*(W-2*M)/3, ACY+50);
    box(M+120+2*(W-2*M)/3, ACY+36, 18, 18); g.font=reg(12); g.fillText('ACCEPT', M+144+2*(W-2*M)/3, ACY+50);
    box(M+240+2*(W-2*M)/3, ACY+36, 18, 18); g.fillText('REJECT', M+264+2*(W-2*M)/3, ACY+50);
    if((r.decision||'ACCEPT')==='ACCEPT'){ g.fillText('X', M+124+2*(W-2*M)/3, ACY+50); } else { g.fillText('X', M+244+2*(W-2*M)/3, ACY+50); }

    lab('COMMENTS', M+10, ACY+50+ac.rw); wrap(g, r.comments, M+120, ACY+38+ac.rw, W-2*M-140, 18);

    // PHOTOS section line only (no thumbnails)
    const PHY=ACY+28+96+18; cap('PHOTOS', M+8, PHY+22);
    box(M, PHY+28, W-2*M, 180);

    pages.push(c);
  }
  return pages;
}
function wrap(g, text, x, y, maxW, lh){ g.font='14px Arial'; g.fillStyle='#000'; g.textBaseline='top';
  const words=(text||'').toUpperCase().split(/\s+/); let line='', yy=y;
  for(const w of words){ const t=line? line+' '+w:w; if(g.measureText(t).width>maxW){ g.fillText(line,x,yy); line=w; yy+=lh; } else line=t; } if(line) g.fillText(line,x,yy);
}
function norm(r){
  return {
    jobNo:(r.jobNo||''), date:(r.date||''), title:(r.title||''), qty:(r.qty||''),
    vendor:(r.vendor||''), po:(r.po||''), product:(r.product||''), grade:(r.grade||''),
    specPrefix:(r.specPrefix||''), specCode:(r.specCode||''), fitting:(r.fitting||''),
    th:(r.th||[]), length:(r.length||''), width:(r.width||''), diameter:(r.diameter||''),
    dimOther:(r.dimOther||''), diaType:(r.diaType||''), marking:(r.marking||''),
    markingCode:(r.markingCode||''), mtrOk:(r.mtrOk||''), visualOk:(r.visualOk||''),
    b16Ok:(r.b16Ok||''), decision:(r.decision||'ACCEPT'), comments:(r.comments||''),
    photos:(r.photos||[])
  };
}

/* ==== PDF from JPEG pages (unchanged) ==== */
function buildPdfFromJpegs(jpegsU8, pageWpt=612, pageHpt=792){
  const parts=[]; const xref=[null]; let offset=0; const enc=new TextEncoder(); const push=u8=>{parts.push(u8); offset+=u8.length;}; const pushS=s=>push(enc.encode(s));
  pushS('%PDF-1.4\n'); const cat=1,pages=2; xref[cat]=offset; pushS(`${cat} 0 obj\n<< /Type /Catalog /Pages ${pages} 0 R >>\nendobj\n`);
  xref[pages]=offset; pushS(`${pages} 0 obj\n<< /Type /Pages /Count ${jpegsU8.length} /Kids [ `);
  let next=3; const kids=[]; for(let i=0;i<jpegsU8.length;i++){ kids.push(next+2); next+=3; }
  pushS(kids.map(id=>`${id} 0 R `).join('')); pushS(`] >>\nendobj\n`); next=3;
  for(let i=0;i<jpegsU8.length;i++){ const imgId=next++, contId=next++, pageId=next++; const img=jpegsU8[i];
    xref[imgId]=offset; pushS(`${imgId} 0 obj\n<< /Type /XObject /Subtype /Image /Filter /DCTDecode /ColorSpace /DeviceRGB /BitsPerComponent 8 /Width ${pageWpt} /Height ${pageHpt} /Length ${img.length} >>\nstream\n`); push(img); pushS(`\nendstream\nendobj\n`);
    const content=`q\n${pageWpt} 0 0 ${pageHpt} 0 0 cm\n/Im${i} Do\nQ\n`;
    xref[contId]=offset; pushS(`${contId} 0 obj\n<< /Length ${content.length} >>\nstream\n${content}\nendstream\nendobj\n`);
    xref[pageId]=offset; pushS(`${pageId} 0 obj\n<< /Type /Page /Parent ${pages} 0 R /MediaBox [0 0 ${pageWpt} ${pageHpt}] /Resources << /XObject << /Im${i} ${imgId} 0 R >> >> /Contents ${contId} 0 R >>\nendobj\n`);
  }
  const xrefStart=offset; pushS(`xref\n0 ${xref.length}\n0000000000 65535 f \n`); for(let i=1;i<xref.length;i++){ const off=String(xref[i]||0).padStart(10,'0'); pushS(`${off} 00000 n \n`); }
  pushS(`trailer\n<< /Size ${xref.length} /Root 1 0 R >>\nstartxref\n${xrefStart}\n%%EOF`);
  return new Blob(parts,{type:'application/pdf'});
}

/* ==== image util + JPEG compress ==== */
function loadImage(src){ return new Promise(res=>{ const im=new Image(); im.onload=()=>res(im); im.src=src; }); }
async function compressDataUrlToJpegU8(dataUrl, maxDim=1600, quality=0.85){
  const img = await loadImage(dataUrl); const scale = Math.min(1, maxDim/Math.max(img.width,img.height));
  const w = Math.max(1, Math.round(img.width*scale)); const h = Math.max(1, Math.round(img.height*scale));
  const c=document.createElement('canvas'); c.width=w; c.height=h; c.getContext('2d').drawImage(img,0,0,w,h);
  const out=c.toDataURL('image/jpeg', quality); return {u8:dataURLtoU8(out)};
}

/* ==== ZIP (compat) ==== */
function zipStoreCompat(files) {
  const enc = new TextEncoder(), LE2=n=>new Uint8Array([n&255,(n>>>8)&255]), LE4=n=>new Uint8Array([n&255,(n>>>8)&255,(n>>>16)&255,(n>>>24)&255]);
  const concat = arrs => { let len=0; for(const a of arrs) len+=a.length; const out=new Uint8Array(len); let o=0; for(const a of arrs){ out.set(a,o); o+=a.length; } return out; };
  const crc32=u8=>{ let c=~0>>>0; for(let i=0;i<u8.length;i++){ c^=u8[i]; for(let k=0;k<8;k++) c=(c>>>1)^(0xEDB88320&-(c&1)); } return (~c)>>>0; };
  const now=new Date(); const dosTime=((now.getHours()&31)<<11)|((now.getMinutes()&63)<<5)|((now.getSeconds()/2)&31);
  const dosDate=(((now.getFullYear()-1980)&127)<<9)|(((now.getMonth()+1)&15)<<5)|(now.getDate()&31);
  const norm = files.map(f=>({ name:sanitize((f.name||'').replace(/\\/g,'/')), dir:!!f.dir, data:f.data? (f.data instanceof Uint8Array?f.data:new Uint8Array(f.data)):new Uint8Array() }));
  const locals=[], centrals=[]; let offset=0;
  for(const f of norm){
    const nameBytes=enc.encode(f.name); const isDir=f.dir||f.name.endsWith('/'); const data=isDir?new Uint8Array():f.data; const crc=isDir?0:crc32(data); const size=data.length;
    const local=concat([enc.encode('PK\x03\x04'),LE2(20),LE2(0),LE2(0),LE2(dosTime),LE2(dosDate),LE4(crc),LE4(size),LE4(size),LE2(nameBytes.length),LE2(0),nameBytes]);
    locals.push(local,data);
    const central=concat([enc.encode('PK\x01\x02'),LE2(20),LE2(20),LE2(0),LE2(0),LE2(dosTime),LE2(dosDate),LE4(crc),LE4(size),LE4(size),LE2(nameBytes.length),LE2(0),LE2(0),LE2(isDir?0x10:0),LE2(0),LE4(isDir?0x10:0),LE4(offset),nameBytes]);
    centrals.push(central); offset += local.length + data.length;
  }
  const localsAll=concat(locals), centralsAll=concat(centrals);
  const end=concat([enc.encode('PK\x05\x06'),LE2(0),LE2(0),LE2(norm.length),LE2(norm.length),LE4(centralsAll.length),LE4(localsAll.length),LE2(0)]);
  return new Blob([localsAll, centralsAll, end], {type:'application/zip'});
}

/* ==== delete & init & SW ==== */
$('deleteBtn').onclick=()=>{ $('confirmBox').style.display='block'; };
$('yesDel').onclick=()=>{ if(!current)return; const has=readRecv().some(r=>r.jobNo===current.jobNo); if(has){alert('CANNOT DELETE — JOB HAS RECEIVING REPORTS');return;} writeJobs(readJobs().filter(j=>j.jobNo!==current.jobNo)); closeMenu(); renderJobs(); };
$('noDel').onclick=()=>{ $('confirmBox').style.display='none'; };

(function init(){ if(!$('startDate').value) $('startDate').value=today(); renderJobs(); })();
(async()=>{ if(!('serviceWorker'in navigator))return; try{const r=await navigator.serviceWorker.register('service_worker.js'); if(r.waiting) r.waiting.postMessage({type:'SKIP_WAITING'});}catch(e){} })();
</script>
</body>
</html>
