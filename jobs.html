<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>WELDERS HELPER — JOBS</title>
<meta name="theme-color" content="#0A0F1A" />
<link rel="manifest" href="manifest.webmanifest" />
<style>
  :root {
    --bg:#0A0F1A;--panel:#101826;--border:#223046;--fg:#E6EAF0;
    --muted:#8FA3BD;--accent:#26D07C;--danger:#FF5A5F;--focus:#8AB4F8
  }
  *{box-sizing:border-box}html,body{height:100%;margin:0}
  body{
    background:var(--bg);color:var(--fg);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    letter-spacing:.02em
  }
  header{position:sticky;top:0;background:#0C1320CC;
    backdrop-filter:blur(6px);border-bottom:1px solid var(--border)}
  .nav{display:flex;gap:12px;align-items:center;padding:12px 16px;
    max-width:1120px;margin:0 auto}
  .brand{font-weight:900}
  .btn{border:1px solid var(--border);background:#0F172A;color:#E6EAF0;
    padding:10px 14px;border-radius:12px;font-weight:900;
    letter-spacing:.04em;text-transform:uppercase;cursor:pointer;text-decoration:none}
  .btn.primary{background:var(--accent);color:#052e16;border-color:#1B9E64}
  .btn.danger{background:var(--danger);border-color:#D83A3F}
  .btn:focus{outline:3px solid var(--focus);outline-offset:2px}
  main{max-width:1120px;margin:24px auto;padding:0 16px}
  .card{background:var(--panel);border:1px solid var(--border);
    border-radius:16px;padding:16px;margin-bottom:16px}
  label{font-size:12px;color:var(--muted);font-weight:800;display:block;margin-bottom:6px}
  input{width:100%;padding:12px 12px;border-radius:12px;border:1px solid var(--border);
    background:#0D1424;color:#E6EAF0;text-transform:uppercase;font-weight:800}
  .row{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px}
  .pill{display:inline-block;padding:4px 10px;border-radius:999px;background:#0F172A;
    border:1px solid var(--border);font-size:12px;font-weight:800}
  table{width:100%;border-collapse:collapse}
  th,td{border-bottom:1px solid var(--border);padding:14px 10px}
  th{font-size:11px;color:#8FA3BD;text-transform:uppercase;letter-spacing:.06em}
  .empty{color:var(--muted);text-align:center;padding:18px;text-transform:uppercase}
  .overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;
    align-items:center;justify-content:center;z-index:50}
  .sheet{width:min(620px,92%);background:var(--panel);border:1px solid var(--border);
    border-radius:18px;padding:18px;box-shadow:0 20px 60px rgba(0,0,0,.45)}
  .sheet h2{margin:0 0 6px 0;font-size:20px;text-transform:uppercase}
  .meta{color:#E6EAF0;font-size:22px;font-weight:900;letter-spacing:.06em;margin:2px 0 12px 0}
  .stack{display:flex;flex-direction:column;gap:10px;align-items:center}
  .wide{width:100%;text-align:center}
  .confirm{display:none;margin-top:10px;text-align:center}
  .confirm .rowc{display:flex;gap:10px;justify-content:center;margin-top:10px}
  .small{font-size:12px;color:#8FA3BD}
</style>
</head>
<body>
<header>
  <nav class="nav">
    <a class="btn" href="app.html">← APP</a>
    <div class="brand">JOBS</div>
    <div style="flex:1"></div>
    <span class="pill">OFFLINE READY</span>
  </nav>
</header>

<main>
  <section class="card">
    <div class="row">
      <div><label for="jobNo">JOB NO. (MAX 8) *</label><input id="jobNo" maxlength="8" /></div>
      <div><label for="desc">DESC. (MAX 12)</label><input id="desc" maxlength="12" /></div>
      <div><label for="startDate">START DATE</label><input id="startDate" type="date" /></div>
    </div>
    <div style="display:flex;gap:12px;margin-top:12px;flex-wrap:wrap">
      <button id="createBtn" class="btn primary">CREATE JOB</button>
      <button id="clearBtn" class="btn">CLEAR</button>
    </div>
  </section>

  <section class="card">
    <table>
      <thead><tr><th>JOB</th><th>DESC</th><th>START</th><th>CREATED</th></tr></thead>
      <tbody id="jobsBody"><tr><td colspan="4" class="empty">NO JOBS YET</td></tr></tbody>
    </table>
    <div class="small">TIP: TAP A ROW FOR ACTIONS</div>
  </section>
</main>

<div id="overlay" class="overlay">
  <div class="sheet">
    <h2>JOB ACTIONS</h2>
    <div id="dlgMeta" class="meta">JOB — DESC</div>
    <div class="stack">
      <a id="viewBtn" class="btn primary wide" href="#">VIEW JOB</a>
      <button id="exportBtn" class="btn wide">EXPORT REPORTS</button>
      <button id="deleteBtn" class="btn danger wide">DELETE JOB</button>
      <button id="closeBtn" class="btn wide">CLOSE</button>
      <div id="confirmBox" class="confirm">
        <div>ARE YOU SURE YOU WANT TO DELETE THIS JOB?</div>
        <div class="rowc">
          <button id="yesDel" class="btn danger">YES</button>
          <button id="noDel" class="btn">NO</button>
        </div>
      </div>
      <div id="zipNote" class="small"></div>
    </div>
  </div>
</div>

<script>
/* ===== STORAGE HELPERS ===== */
const JOBS_KEY='wh_jobs_v1', RECV_KEY='wh_receiving_v1';
const $=id=>document.getElementById(id);
const readJobs=()=>JSON.parse(localStorage.getItem(JOBS_KEY)||'[]');
const writeJobs=a=>localStorage.setItem(JOBS_KEY,JSON.stringify(a));
const readRecv=()=>JSON.parse(localStorage.getItem(RECV_KEY)||'[]');
const today=()=>new Date().toISOString().slice(0,10);
function sanitize(s){return (s||'').toUpperCase().replace(/[^A-Z0-9\-_. /]/g,'_').replace(/\s+/g,'-');}
function dataURLtoU8(d){const i=d.indexOf(',');const bin=atob(d.slice(i+1));const u8=new Uint8Array(bin.length);for(let k=0;k<bin.length;k++)u8[k]=bin.charCodeAt(k);return u8;}
function blobToU8(blob){return blob.arrayBuffer().then(b=>new Uint8Array(b));}
function saveBlobSmart(name, blob){
  const url = URL.createObjectURL(blob);
  if (/iPad|iPhone|iPod/.test(navigator.userAgent)) window.open(url, '_blank');
  else {const a=document.createElement('a');a.href=url;a.download=name;a.click();}
  setTimeout(()=>URL.revokeObjectURL(url),30000);
}

/* ===== JOBS TABLE ===== */
function renderJobs(){
  const rows=readJobs().sort((a,b)=>b.createdAt.localeCompare(a.createdAt));
  const tb=$('jobsBody'); tb.innerHTML='';
  if(!rows.length){tb.innerHTML='<tr><td colspan="4" class="empty">NO JOBS YET</td></tr>';return;}
  for(const j of rows){
    const tr=document.createElement('tr'); tr.className='jobrow'; tr.dataset.job=j.jobNo;
    tr.innerHTML=`<td><span class="pill">${j.jobNo}</span></td>
      <td>${(j.desc||'').toUpperCase()}</td>
      <td>${j.startDate||''}</td>
      <td>${new Date(j.createdAt).toLocaleString().toUpperCase()}</td>`;
    tb.appendChild(tr);
  }
}
$('jobsBody').onclick=(e)=>{const tr=e.target.closest('tr.jobrow');if(tr)openMenu(tr.dataset.job);};
$('createBtn').onclick=()=>{
  const jobNo=$('jobNo').value.trim().toUpperCase();
  const desc=$('desc').value.trim().toUpperCase();
  const start=$('startDate').value||today();
  if(!jobNo)return alert('JOB NO. REQUIRED');
  if(jobNo.length>8)return alert('JOB NO. MUST BE ≤ 8');
  if(readJobs().some(j=>j.jobNo===jobNo))return alert('JOB NO. ALREADY EXISTS');
  const now=new Date().toISOString();
  const jobs=readJobs();jobs.unshift({id:crypto.randomUUID(),jobNo,desc,startDate:start,createdAt:now});
  writeJobs(jobs);$('jobNo').value='';$('desc').value='';$('startDate').value=today();renderJobs();
};
$('clearBtn').onclick=()=>{$('jobNo').value='';$('desc').value='';};

/* ===== ACTION MENU ===== */
let current=null;
function openMenu(jobNo){
  const job=readJobs().find(j=>j.jobNo===jobNo);if(!job)return;
  current=job;$('dlgMeta').textContent=`${job.jobNo} — ${(job.desc||'')}`;
  $('viewBtn').href=`job.html?job=${encodeURIComponent(job.jobNo)}`;
  $('confirmBox').style.display='none';$('zipNote').textContent='';
  $('overlay').style.display='flex';$('closeBtn').focus();
}
$('closeBtn').onclick=()=>$('overlay').style.display='none';
$('overlay').onclick=(e)=>{if(e.target===e.currentTarget)$('overlay').style.display='none';};

/* ===== EXPORT REPORTS ===== */
$('exportBtn').onclick=async(ev)=>{
  ev.preventDefault();if(!current)return;
  const entries=readRecv().filter(r=>r.jobNo===current.jobNo);
  if(!entries.length){alert('NO RECEIVING ENTRIES FOR THIS JOB');return;}

  const canvases=await renderLetterReports(entries);
  const jpegs=await Promise.all(canvases.map(c=>blobToU8(await new Promise(r=>c.toBlob(r,'image/jpeg',0.95)))));
  const pdf=buildPdfFromJpegs(jpegs,612,792);
  const pdfU8=await blobToU8(pdf);

  const base=`${sanitize(current.jobNo)}_${sanitize(current.desc||'')}`.replace(/_$/,'');
  const files=[{name:`${base}-REPORT.pdf`,data:pdfU8},{name:'PHOTOS/',dir:true}];
  for(const r of entries){for(let i=0;i<(r.photos||[]).length;i++){
    const p=r.photos[i];const imgU8=dataURLtoU8(p.dataUrl);
    files.push({name:`PHOTOS/${sanitize(r.jobNo)}-${sanitize(r.title||'ITEM')} (${i+1}).jpg`,data:imgU8});
  }}
  const zip=zipStoreCompat(files);
  saveBlobSmart(`${base}-DOCS.zip`,zip);
};

/* ===== DRAW 8.5x11 PDF PAGE ===== */
async function renderLetterReports(rows){
  const W=612*2,H=792*2,M=36*2,pages=[];
  for(const r of rows){
    const c=document.createElement('canvas');c.width=W;c.height=H;
    const g=c.getContext('2d');g.fillStyle='#FFF';g.fillRect(0,0,W,H);
    g.strokeStyle='#000';g.lineWidth=1.5;g.font=`bold ${18}px Arial`;g.textAlign='center';
    g.fillText('RECEIVING INSPECTION REPORT',W/2,M+10);g.textAlign='left';
    const Y=(y)=>M+y;const X=(x)=>M+x;
    const box=(x,y,w,h)=>{g.strokeRect(X(x),Y(y),w,h)};
    g.font='bold 12px Arial';g.fillText('JOB NO:',X(10),Y(50));g.fillText((r.jobNo||''),X(100),Y(50));
    g.fillText('TITLE:',X(10),Y(75));g.fillText((r.title||''),X(100),Y(75));
    g.fillText('VENDOR:',X(10),Y(100));g.fillText((r.vendor||''),X(100),Y(100));
    g.fillText('PO:',X(300),Y(100));g.fillText((r.po||''),X(350),Y(100));
    g.fillText('DATE:',X(300),Y(50));g.fillText((r.date||''),X(360),Y(50));
    // grid lines below can be expanded to add your specific fields neatly
    g.strokeRect(M,Y(120),W-2*M,H-Y(160));
    pages.push(c);
  }return pages;
}

/* ===== ZIP, PDF BUILDERS (unchanged) ===== */
function zipStoreCompat(files){/* same as before */} // (keep your existing function)
function buildPdfFromJpegs(jpegsU8,pageWpt=612,pageHpt=792){/* same as before */}

/* ===== DELETE JOB ===== */
$('deleteBtn').onclick=()=>$('confirmBox').style.display='block';
$('yesDel').onclick=()=>{if(!current)return;
  const has=readRecv().some(r=>r.jobNo===current.jobNo);
  if(has){alert('CANNOT DELETE — JOB HAS RECEIVING REPORTS');return;}
  writeJobs(readJobs().filter(j=>j.jobNo!==current.jobNo));
  $('overlay').style.display='none';renderJobs();
};
$('noDel').onclick=()=>$('confirmBox').style.display='none';

/* ===== INIT ===== */
(function init(){if(!$('startDate').value)$('startDate').value=today();renderJobs();})();
(async()=>{if(!('serviceWorker'in navigator))return;
  try{const r=await navigator.serviceWorker.register('service_worker.js');
  if(r.waiting)r.waiting.postMessage({type:'SKIP_WAITING'});}catch(e){}})();
  <script>
/* --------- RUNTIME HOT-FIX PATCH FOR CREATE JOB --------- */
/* Why: some devices lack crypto.randomUUID, or an earlier error stops the handler. */

(function() {
  const statusId = 'wh_status';
  if (!document.getElementById(statusId)) {
    const s = document.createElement('div');
    s.id = statusId;
    s.style.position = 'fixed';
    s.style.bottom = '10px';
    s.style.right = '10px';
    s.style.background = '#111827';
    s.style.border = '1px solid #223046';
    s.style.color = '#E6EAF0';
    s.style.padding = '6px 10px';
    s.style.borderRadius = '10px';
    s.style.fontSize = '12px';
    s.style.zIndex = '9999';
    s.textContent = 'READY';
    document.body.appendChild(s);
  }
  const setStatus = (t) => { const el = document.getElementById(statusId); if (el) el.textContent = t; };

  // Fallback ID generator
  function randomId() {
    try { if (crypto && crypto.randomUUID) return crypto.randomUUID(); } catch(_) {}
    return 'id-' + Date.now().toString(36) + '-' + Math.random().toString(36).slice(2,8).toUpperCase();
  }

  // Defensive element lookups
  const elJob = document.getElementById('jobNo');
  const elDesc = document.getElementById('desc');
  const elDate = document.getElementById('startDate');
  const btnCreate = document.getElementById('createBtn');

  if (!elJob || !elDesc || !elDate || !btnCreate) {
    setStatus('ERROR: MISSING ELEMENT(S)');
    console.error('Hot-fix: required element missing', { elJob, elDesc, elDate, btnCreate });
    return;
  }

  // Ensure date has a default (today) for devices that don’t auto-fill type=date
  try {
    if (!elDate.value) {
      const iso = new Date().toISOString().slice(0,10);
      elDate.value = iso;
    }
  } catch (e) {
    console.warn('Hot-fix: date init warning', e);
  }

  // Remove any previous onclick to avoid double-binding conflicts
  try { btnCreate.onclick = null; } catch(_) {}

  // Bind robust handler
  btnCreate.addEventListener('click', function onCreate(ev) {
    ev.preventDefault();
    try {
      const jobNo = (elJob.value || '').trim().toUpperCase();
      const desc  = (elDesc.value || '').trim().toUpperCase();
      const start = (elDate.value || new Date().toISOString().slice(0,10));

      if (!jobNo) { alert('JOB NO. REQUIRED'); setStatus('JOB NO. REQUIRED'); return; }
      if (jobNo.length > 8) { alert('JOB NO. MUST BE ≤ 8'); setStatus('JOB NO TOO LONG'); return; }

      let jobs = [];
      try { jobs = JSON.parse(localStorage.getItem('wh_jobs_v1') || '[]'); }
      catch (e) { console.warn('Hot-fix: parse jobs failed, reinit', e); jobs = []; }

      if (jobs.some(j => j.jobNo === jobNo)) { alert('JOB NO. ALREADY EXISTS'); setStatus('DUPLICATE JOB'); return; }

      const now = new Date().toISOString();
      jobs.unshift({ id: randomId(), jobNo, desc, startDate: start, createdAt: now });
      localStorage.setItem('wh_jobs_v1', JSON.stringify(jobs));

      // Clear fields + refresh table
      elJob.value = ''; elDesc.value = ''; elDate.value = new Date().toISOString().slice(0,10);
      setStatus('JOB CREATED');
      // Re-render if your render function exists
      if (typeof renderJobs === 'function') renderJobs();
    } catch (err) {
      console.error('Hot-fix: create job failed', err);
      alert('CREATE JOB FAILED — SEE CONSOLE');
      setStatus('CREATE FAILED');
    }
  });

  setStatus('PATCHED OK');
})();
</script>

</script>
</body>
</html>
