<!-- ============================== -->
<!-- /jobs.html (drop-in final)    -->
<!-- ============================== -->
<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>WELDERS HELPER — JOBS</title>
<meta name="theme-color" content="#0A0F1A" />
<link rel="manifest" href="manifest.webmanifest" />
<style>
  :root{--bg:#0A0F1A;--panel:#101826;--border:#223046;--fg:#E6EAF0;--muted:#8FA3BD;--accent:#26D07C;--danger:#FF5A5F;--focus:#8AB4F8}
  *{box-sizing:border-box}
  html,body{height:100%;margin:0}
  html{scrollbar-gutter:stable both-edges}
  body{background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;letter-spacing:.02em;overflow-x:hidden}
  body.modal-open{overflow:hidden;touch-action:none}
  header{position:sticky;top:0;background:#0C1320CC;backdrop-filter:blur(6px);border-bottom:1px solid var(--border)}
  .nav{display:flex;gap:12px;align-items:center;padding:12px 16px;max-width:1120px;margin-left:auto;margin-right:auto;
       padding-inline:max(16px,env(safe-area-inset-left)) max(16px,env(safe-area-inset-right))}
  .brand{font-weight:900}
  .btn{border:1px solid var(--border);background:#0F172A;color:#E6EAF0;padding:10px 14px;border-radius:12px;font-weight:900;letter-spacing:.04em;text-transform:uppercase;cursor:pointer;text-decoration:none}
  .btn.primary{background:var(--accent);color:#052e16;border-color:#1B9E64}
  .btn.danger{background:var(--danger);border-color:#D83A3F}
  .btn:focus{outline:3px solid var(--focus);outline-offset:2px}
  main{max-width:1120px;margin:24px auto;padding-inline:max(16px,env(safe-area-inset-left)) max(16px,env(safe-area-inset-right))}
  .card{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:16px;margin-bottom:16px}
  label{font-size:12px;color:var(--muted);font-weight:800;display:block;margin-bottom:6px}
  input{width:100%;padding:12px 12px;border-radius:12px;border:1px solid var(--border);background:#0D1424;color:#E6EAF0;text-transform:uppercase;font-weight:800}
  .row{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px}
  .pill{display:inline-block;padding:4px 10px;border-radius:999px;background:#0F172A;border:1px solid var(--border);font-size:12px}
  table{width:100%;border-collapse:collapse}
  th,td{border-bottom:1px solid var(--border);padding:14px 10px}
  th{font-size:11px;color:#8FA3BD;text-transform:uppercase;letter-spacing:.06em}
  .empty{color:var(--muted);text-align:center;padding:18px;text-transform:uppercase}
  .badge{display:inline-block;min-width:1.6em;text-align:center;padding:2px 6px;border-radius:999px;border:1px solid var(--border);background:#0F172A;font-weight:900;font-size:12px}
  .badge.zero{opacity:.5}
  .btn.hasReports{color:#26D07C}

  /* Backdrop: flex centers the sheet perfectly left-right (and vertically) */
  .overlay{
    position:fixed; inset:0; background:rgba(0,0,0,.52);
    z-index:50; display:none; padding:16px;
  }
  .overlay.open{ display:flex; align-items:center; justify-content:center; }

  /* Sheet: no transform needed; width tightened */
  .sheet{
    position:relative;
    width:min(400px,92vw);
    max-height:calc(90svh - env(safe-area-inset-top) - env(safe-area-inset-bottom));
    overflow:auto;
    background:var(--panel); border:1px solid var(--border);
    border-radius:18px; padding:18px; box-shadow:0 20px 60px rgba(0,0,0,.45);
    margin-inline:auto;
  }
  .sheet h2{margin:0 0 6px 0;font-size:20px;text-transform:uppercase;text-align:center}
  .meta{color:#E6EAF0;font-size:20px;font-weight:900;letter-spacing:.06em;margin:2px 0 10px 0;word-break:break-word;text-align:center}
  .stack{display:flex;flex-direction:column;gap:10px;align-items:center}
  .wide{width:100%;text-align:center}
  .confirm{display:none;margin-top:10px;text-align:center}
  .confirm .rowc{display:flex;gap:10px;justify-content:center;margin-top:10px}
  .small{font-size:12px;color:#8FA3BD;text-align:center}
  .ok{color:#b7f7d2}
  .warn{color:#ffd6d6}
  .progress{height:6px;border-radius:999px;background:#0b1f15;border:1px solid #1B9E64;overflow:hidden;width:100%;display:none}
  .progress > div{height:100%;width:0%;background:#26D07C;transition:width .12s linear}
</style>
</head>
<body>
<header>
  <nav class="nav">
    <a class="btn" href="app.html">← APP</a>
    <div class="brand">JOBS</div>
    <div style="flex:1"></div>
  </nav>
</header>

<main>
  <section class="card">
    <div class="row">
      <div><label for="jobNo">JOB NO. (MAX 8) *</label><input id="jobNo" maxlength="8" /></div>
      <div><label for="desc">DESC. (MAX 12)</label><input id="desc" maxlength="12" /></div>
      <div><label for="startDate">START DATE</label><input id="startDate" type="date" /></div>
    </div>
    <div style="display:flex;gap:12px;margin-top:12px;flex-wrap:wrap">
      <button id="createBtn" class="btn primary">CREATE JOB</button>
      <button id="clearBtn" class="btn">CLEAR</button>
    </div>
  </section>

  <section class="card">
    <table>
      <thead><tr><th>JOB</th><th>DESC</th><th>START</th><th>CREATED</th><th>REPORTS</th></tr></thead>
      <tbody id="jobsBody"><tr><td colspan="5" class="empty">NO JOBS YET</td></tr></tbody>
    </table>
    <div class="small">TIP: TAP A ROW FOR ACTIONS</div>
  </section>
</main>

<!-- ACTION MENU -->
<div id="overlay" class="overlay" role="dialog" aria-modal="true">
  <div class="sheet" role="document">
    <h2>JOB ACTIONS</h2>
    <div id="dlgMeta" class="meta">JOB — DESC</div>

    <div class="progress" id="exportProg"><div></div></div>
    <div id="zipNote" class="small" style="min-height:1.2em"></div>

    <div class="stack" style="margin-top:8px">
      <a id="viewBtn" class="btn primary wide" href="#">VIEW JOB</a>
      <button id="exportBtn" class="btn wide">EXPORT REPORTS & PHOTOS</button>
      <button id="deleteBtn" class="btn danger wide">DELETE JOB</button>
      <button id="closeBtn" class="btn wide">CLOSE</button>

      <div id="confirmBox" class="confirm">
        <div>ARE YOU SURE YOU WANT TO DELETE THIS JOB?</div>
        <div class="rowc">
          <button id="yesDel" class="btn danger">YES</button>
          <button id="noDel" class="btn">NO</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
/* ============================ CONFIG ============================ */
localStorage.setItem('wh_max_photos','4');

/* ============================ STORAGE ============================ */
const JOBS_KEY='wh_jobs_v1', RECV_KEY='wh_receiving_v1';
const $=id=>document.getElementById(id);
const safeRead=(k)=>{ try{const s=localStorage.getItem(k);return s?JSON.parse(s):[]}catch{ return []} };
const safeWrite=(k,v)=>{ try{localStorage.setItem(k,JSON.stringify(v)); localStorage.setItem('wh_last_change', String(Date.now()));}catch{} };
const readJobs=()=>safeRead(JOBS_KEY);
const writeJobs=(a)=>safeWrite(JOBS_KEY,a);
const readRecv=()=>safeRead(RECV_KEY);
const writeRecv=(a)=>safeWrite(RECV_KEY,a);
const today=()=>new Date().toISOString().slice(0,10);
const sanitize=s=>(s||'').toUpperCase().replace(/[^A-Z0-9\-_. ]/g,'_').replace(/\s+/g,'-');

/* ============================ IndexedDB (read photos) =========== */
const DB_NAME='wh_db', DB_VER=1, DB_PHOTOS='photos';
function openDB(){return new Promise((res,rej)=>{const r=indexedDB.open(DB_NAME,DB_VER);r.onupgradeneeded=()=>{const db=r.result;if(!db.objectStoreNames.contains(DB_PHOTOS))db.createObjectStore(DB_PHOTOS,{keyPath:'id'});};r.onsuccess=()=>res(r.result);r.onerror=()=>rej(r.error);});}
async function idbGetPhoto(id){const db=await openDB();return new Promise((res,rej)=>{const tx=db.transaction(DB_PHOTOS,'readonly');const rq=tx.objectStore(DB_PHOTOS).get(id);rq.onsuccess=()=>res(rq.result||null);rq.onerror=()=>rej(rq.error);});}

/* ====================== PDF BUILDER ============================= */
function buildPdfFromJpegsExact(pages, pageWpt=612, pageHpt=792){
  const parts=[]; const enc=new TextEncoder(); let offset=0; const xref=[null];
  const addS=s=>{const u8=enc.encode(s); parts.push(u8); offset+=u8.length;};
  const addU8=u8=>{parts.push(u8); offset+=u8.length;};
  const obj=(id,body)=>{ xref[id]=offset; addS(`${id} 0 obj\n${body}\nendobj\n`); };
  addS('%PDF-1.4\n');
  obj(1, `<< /Type /Catalog /Pages 2 0 R >>`);
  obj(2, `<< /Type /Pages /Count ${pages.length} /Kids [ ${pages.map((_,i)=>`${3+i*3+2} 0 R`).join(' ')} ] >>`);
  pages.forEach((pg,i)=>{
    const imgId=3+i*3, cntId=4+i*3, pageId=5+i*3;
    addS(`${imgId} 0 obj\n<< /Type /XObject /Subtype /Image /Filter /DCTDecode /ColorSpace /DeviceRGB /BitsPerComponent 8 /Width ${pg.w} /Height ${pg.h} /Length ${pg.u8.length} >>\nstream\n`);
    addU8(pg.u8); addS(`\nendstream\nendobj\n`);
    const content=`q\n${pageWpt} 0 0 ${pageHpt} 0 0 cm\n/Im${i} Do\nQ\n`;
    obj(cntId, `<< /Length ${content.length} >>\nstream\n${content}\nendstream`);
    obj(pageId, `<< /Type /Page /Parent 2 0 R /MediaBox [0 0 ${pageWpt} ${pageHpt}] /Resources << /XObject << /Im${i} ${imgId} 0 R >> >> /Contents ${cntId} 0 R >>`);
  });
  const startXref=offset;
  addS(`xref\n0 ${xref.length}\n0000000000 65535 f \n`);
  for(let i=1;i<xref.length;i++) addS(`${String(xref[i]).padStart(10,'0')} 00000 n \n`);
  addS(`trailer\n<< /Size ${xref.length} /Root 1 0 R >>\nstartxref\n${startXref}\n%%EOF`);
  return new Blob(parts,{type:'application/pdf'});
}

/* ============================ UI: LIST =========================== */
function countReports(jobNo){ return readRecv().filter(r=>r.jobNo===jobNo).length; }
function renderJobs(){
  const rows=readJobs().sort((a,b)=>b.createdAt.localeCompare(a.createdAt));
  const tb=$('jobsBody'); tb.innerHTML='';
  if(!rows.length){tb.innerHTML='<tr><td colspan="5" class="empty">NO JOBS YET</td></tr>';return;}
  for(const j of rows){
    const n=countReports(j.jobNo);
    const tr=document.createElement('tr'); tr.className='jobrow'; tr.dataset.job=j.jobNo;
    tr.innerHTML=`<td><span class="pill">${j.jobNo}</span></td>
      <td>${(j.desc||'').toUpperCase()}</td>
      <td>${j.startDate||''}</td>
      <td>${new Date(j.createdAt).toLocaleString().toUpperCase()}</td>
      <td><span class="badge ${n? '' : 'zero'}">${n}</span></td>`;
    tb.appendChild(tr);
  }
}
$('jobsBody').onclick=(e)=>{const tr=e.target.closest('tr.jobrow'); if(tr) openMenu(tr.dataset.job);};

/* ============================ CREATE ============================ */
$('createBtn').onclick=()=>{
  const jobNo=$('jobNo').value.trim().toUpperCase();
  const desc=$('desc').value.trim().toUpperCase();
  const start=$('startDate').value || today();
  if(!jobNo) return alert('JOB NO. REQUIRED');
  if(jobNo.length>8) return alert('JOB NO. MUST BE ≤ 8');
  if(readJobs().some(j=>j.jobNo===jobNo)) return alert('JOB NO. ALREADY EXISTS');
  const now=new Date().toISOString();
  const id=(crypto.randomUUID&&crypto.randomUUID())||Math.random().toString(36).slice(2);
  const jobs=readJobs(); jobs.unshift({id,jobNo,desc,startDate:start,createdAt:now}); writeJobs(jobs);
  $('jobNo').value=''; $('desc').value=''; $('startDate').value=today();
  renderJobs();
};
$('clearBtn').onclick=()=>{$('jobNo').value='';$('desc').value='';};

/* ============================ ACTIONS =========================== */
let current=null;
function openMenu(jobNo){
  const job=readJobs().find(j=>j.jobNo===jobNo); if(!job) return;
  current=job; $('dlgMeta').textContent=`${job.jobNo} — ${(job.desc||'')}`;
  $('viewBtn').href=`job.html?job=${encodeURIComponent(job.jobNo)}`;
  $('confirmBox').style.display='none'; $('zipNote').textContent='';
  const hasReports = countReports(job.jobNo) > 0;
  $('exportBtn').classList.toggle('hasReports', hasReports);
  $('overlay').classList.add('open'); document.body.classList.add('modal-open'); $('closeBtn').focus();
}
function closeMenu(){ $('overlay').classList.remove('open'); document.body.classList.remove('modal-open'); current=null; }
$('closeBtn').onclick=closeMenu;
$('overlay').addEventListener('click',(e)=>{ if(e.target===e.currentTarget) closeMenu(); });
document.addEventListener('keydown',(e)=>{ if(e.key==='Escape' && $('overlay').classList.contains('open')) closeMenu(); });

/* DELETE JOB */
$('deleteBtn').onclick=()=>{ $('confirmBox').style.display='block'; };
$('noDel').onclick =()=>{ $('confirmBox').style.display='none'; };
$('yesDel').onclick=()=>{
  if(!current) return;
  writeJobs(readJobs().filter(j=>j.jobNo!==current.jobNo));
  writeRecv(readRecv().filter(r=>r.jobNo!==current.jobNo));
  current=null; renderJobs(); closeMenu();
};

/* ============================ EXPORT (PDF + PHOTOS → ZIPs) ====== */
$('exportBtn').onclick = async (ev) => {
  ev.preventDefault();
  if (!current) return;

  const entries = readRecv().filter(r => r.jobNo === current.jobNo);
  if (!entries.length) { alert('NO RECEIVING ENTRIES FOR THIS JOB'); return; }

  const setNote = (msg, cls='') => { const n=$('zipNote'); n.textContent=msg; n.className='small '+cls; };
  const progWrap = $('exportProg'), progBar = progWrap.firstElementChild;
  const setProg = (pct) => { progWrap.style.display='block'; progBar.style.width = Math.max(0, Math.min(100, pct)) + '%'; };

  try{
    setNote('Building PDF…'); setProg(25);
    const canvases = await renderReceivingPdfPages(entries);
    const pages = canvases.map(c => ({ u8: dataURLtoU8(c.toDataURL('image/jpeg', 0.92)), w: c.width, h: c.height }));
    const pdfBlob  = buildPdfFromJpegsExact(pages, 612, 792);
    const pdfU8 = new Uint8Array(await pdfBlob.arrayBuffer());

    setNote('Preparing ZIP…'); setProg(60);

    const files = [];
    const base = `${sanitize(current.jobNo)}_RECEIVING`;
    files.push({name:`${base}.pdf`, u8: pdfU8});

    let photoCount = 0;
    let seq = 1;
    for (let idx = 0; idx < entries.length; idx++) {
      const r = normalizeEntry(entries[idx]);
      const prefix = `${sanitize(r.jobNo)}_${(r.date||`ENTRY-${idx+1}`)}`; // flattened
      for (let i = 0; i < (r.photos||[]).length; i++) {
        const ph = r.photos[i]; if (!ph) continue;
        const u8 = await resolvePhotoU8(ph); if (!u8) continue;
        const n = String(seq++).padStart(3,'0');
        files.push({name:`${prefix}_PHOTO-${n}.jpg`, u8});
        photoCount++;
      }
    }

    setProg(85);
    const zips = buildZipPartsDeflate(files, `${sanitize(current.jobNo)}_EXPORT`, 20 * 1024 * 1024);
    if (!zips.length) throw new Error('Nothing to export.');

    for (const {blob, name} of zips) {
      const zurl = URL.createObjectURL(blob);
      triggerDownload(zurl, name);
      setTimeout(()=>URL.revokeObjectURL(zurl), 30000);
    }

    setProg(100);
    setNote(`Exported ${zips.length} ZIP file${zips.length>1?'s':''} • PDF + ${photoCount} photo${photoCount!==1?'s':''}.`, 'ok');
  } catch(e){
    setNote(`Export failed: ${e?.message || 'Unexpected error.'}`, 'warn');
  }
};

/* ---------- PDF RENDER (letter portrait) ------------------------ */
async function renderReceivingPdfPages(entries){
  const W=1275, H=1650, M=75; const pages=[];
  for(const raw of entries){
    const r = normalizeEntry(raw);
    const c=document.createElement('canvas'); c.width=W; c.height=H;
    const g=c.getContext('2d'); g.fillStyle='#fff'; g.fillRect(0,0,W,H);
    g.strokeStyle='#000'; g.lineWidth=1;

    const B=(px)=>`bold ${px}px Arial`; const R=(px)=>`${px}px Arial`;
    const text=(s,x,y,px=14,b=false)=>{ g.font=b?B(px):R(px); g.fillStyle='#000'; g.textBaseline='alphabetic'; g.fillText((s||'').toUpperCase(),x,y); };
    const box =(x,y,w,h)=>g.strokeRect(x,y,w,h);
    const hln =(x1,y,x2)=>{ g.beginPath(); g.moveTo(x1,y); g.lineTo(x2,y); g.stroke(); };
    const vln =(x,y1,y2)=>{ g.beginPath(); g.moveTo(x,y1); g.lineTo(x,y2); g.stroke(); };
    const wrap=(s,x,y,maxW,lh=18,px=14)=>{ g.font=R(px); let line='',yy=y; (s||'').toUpperCase().split(/\s+/).forEach(w=>{ const t=line? line+' '+w:w; if(g.measureText(t).width>maxW){ g.fillText(line,x,yy); yy+=lh; line=w; } else line=t; }); if(line) g.fillText(line,x,yy); };

    text('RECEIVING REPORTS', M, M+22, 22, true);
    hln(M, M+28, W-M);

    let y=M+40;
    text('IDENTIFICATION', M+6, y+18, 14, true);
    const IDH=124; box(M,y+24,W-2*M,IDH);
    const rw=IDH/3; const midX=M+(W-2*M)/2;
    hln(M, y+24+rw, W-M); hln(M, y+24+2*rw, W-M); vln(midX, y+24, y+24+IDH);
    text('JOB NO.',   M+12, y+24+rw-8, 12, true); text(r.jobNo,   M+120, y+24+rw-8);
    text('DATE',     midX+12, y+24+rw-8, 12, true); text(r.date, midX+100, y+24+rw-8);
    text('TITLE',    M+12, y+24+2*rw-8, 12, true); text(r.title,   M+120, y+24+2*rw-8);
    text('QUANTITY', midX+12, y+24+2*rw-8, 12, true); text(r.qty,  midX+120, y+24+2*rw-8);
    text('VENDOR',   M+12, y+24+3*rw-8, 12, true); text(r.vendor,  M+120, y+24+3*rw-8);
    text('PO.',      midX+12, y+24+3*rw-8, 12, true); text(r.po,   midX+100, y+24+3*rw-8);

    y += 24+IDH+16;
    text('SPECIFICATION', M+6, y+18, 14, true);
    const SPH=92; box(M,y+24,W-2*M,SPH);
    const spRw=SPH/2; const spMid=midX;
    hln(M, y+24+spRw, W-M); vln(spMid, y+24, y+24+SPH);
    text('PRODUCT', M+12, y+24+spRw-8, 12, true); text(r.product, M+120, y+24+spRw-8);
    text('GRADE / TYPE', spMid+12, y+24+spRw-8, 12, true); text(r.grade, spMid+140, y+24+spRw-8);
    text('SPEC', M+12, y+24+2*spRw-8, 12, true); text(`${r.specPrefix} ${r.specCode}`, M+120, y+24+2*spRw-8);
    text('FITTING', spMid+12, y+24+2*spRw-8, 12, true); text(r.fitting, spMid+120, y+24+2*spRw-8);

    y += 24+SPH+16;
    text('DIMENSIONS', M+6, y+18, 14, true);
    const DMH=108; box(M,y+24,W-2*M,DMH);
    const dmRw=DMH/3;
    hln(M, y+24+dmRw, W-M); hln(M, y+24+2*dmRw, W-M);
    text('TH', M+12, y+24+dmRw-8, 12, true);
    text((r.th||[]).filter(Boolean).join('   '), M+70, y+24+dmRw-8);
    text('LENGTH', M+12, y+24+2*dmRw-8, 12, true); text(r.length, M+120, y+24+2*dmRw-8);
    text('WIDTH',  midX+12, y+24+2*dmRw-8, 12, true); text(r.width,  midX+100, y+24+2*dmRw-8);
    text('DIAMETER', M+12, y+24+3*dmRw-8, 12, true); text(`${r.diameter} ${r.diaType}`.trim(), M+120, y+24+3*dmRw-8);
    text('OTHER',    midX+12, y+24+3*dmRw-8, 12, true); text(r.dimOther, midX+100, y+24+3*dmRw-8);

    y += 24+DMH+16;
    text('MARKINGS', M+6, y+18, 14, true);
    const MKH=128; box(M,y+24,W-2*M,MKH);
    const mkRw=MKH/3;
    hln(M, y+24+mkRw, W-M); hln(M, y+24+2*mkRw, W-M);
    text('ACTUAL MATERIAL MARKING', M+12, y+24+mkRw-10, 12, true);
    wrap(r.marking, M+12, y+24+mkRw+4, W-2*M-24, 18, 14);
    text('MARKING ACCEPTABLE TO CODE/STANDARD', M+12, y+24+2*mkRw-8, 12, true);
    text(r.markingCode, M+360, y+24+2*mkRw-8);
    text('MTR/COFC ACCEPTABLE TO SPECIFICATION', M+12, y+24+3*mkRw-8, 12, true);
    text(r.mtrOk, M+360, y+24+3*mkRw-8);

    y += 24+MKH+16;
    text('ACCEPTABILITY', M+6, y+18, 14, true);
    const ACH=98; box(M,y+24,W-2*M,ACH);
    const acRw=ACH/2; hln(M, y+24+acRw, W-M);
    text('VISUAL', M+12, y+24+acRw-8, 12, true); text(r.visualOk, M+120, y+24+acRw-8);
    text('B16 DIMENSIONS', midX+12, y+24+acRw-8, 12, true); text(r.b16Ok, midX+180, y+24+acRw-8);

    text('DECISION', M+12, y+24+2*acRw-8, 12, true);
    const bxY=y+24+2*acRw-22;
    g.strokeRect(M+120, bxY, 18, 18); g.fillText('ACCEPT', M+146, y+24+2*acRw-8);
    g.strokeRect(M+240, bxY, 18, 18); g.fillText('REJECT', M+266, y+24+2*acRw-8);
    if((r.decision||'ACCEPT')==='ACCEPT'){ g.font=B(14); g.fillText('X', M+124, y+24+2*acRw-8); }
    else { g.font=B(14); g.fillText('X', M+244, y+24+2*acRw-8); }

    g.font=B(12); g.fillText('COMMENTS', midX+12, y+24+2*acRw-8);
    wrap(r.comments, midX+120, y+24+2*acRw-22, (W-2*M)-(midX-M)-20, 18, 14);

    y += 24+ACH+16;
    g.strokeRect(M,y,W-2*M,44);
    g.font=B(12);
    g.fillText('MATERIAL APPROVAL  APPROVED', M+12, y+28);
    g.fillText('QC MANAGER  INITIALS / DATE', midX+12, y+28);

    pages.push(c);
  }
  return pages;
}
function normalizeEntry(r){
  return {jobNo:r.jobNo||'',date:r.date||'',title:r.title||'',qty:r.qty||'',vendor:r.vendor||'',po:r.po||'',
    product:r.product||'',grade:r.grade||'',specPrefix:r.specPrefix||'',specCode:r.specCode||'',fitting:r.fitting||'',
    th:r.th||[],length:r.length||'',width:r.width||'',diameter:r.diameter||'',dimOther:r.dimOther||'',
    diaType:r.diaType||'',marking:r.marking||'',markingCode:r.markingCode||'',mtrOk:r.mtrOk||'',
    visualOk:r.visualOk||'',b16Ok:r.b16Ok||'',decision:r.decision||'ACCEPT',comments:r.comments||'',photos:r.photos||[]};
}

/* ----------------------- Binary helpers ------------------------- */
function dataURLtoU8(d){ const i=d.indexOf(','); const bin=atob(d.slice(i+1)); const u8=new Uint8Array(bin.length); for(let k=0;k<bin.length;k++) u8[k]=bin.charCodeAt(k); return u8; }
function triggerDownload(url, filename){ const a=document.createElement('a'); a.href=url; a.download=filename; document.body.appendChild(a); a.click(); a.remove(); }

/* Resolve photo refs (idb/dataURL/blob/url/u8) */
async function resolvePhotoU8(ph){
  try{
    if (ph && typeof ph==='object' && ph.store==='idb' && ph.id){ const rec=await idbGetPhoto(ph.id); if(rec?.blob) return new Uint8Array(await rec.blob.arrayBuffer()); }
    if (ph instanceof Uint8Array) return ph;
    if (ph instanceof Blob) return new Uint8Array(await ph.arrayBuffer());
    if (typeof ph === 'string'){ if (ph.startsWith('data:')) return dataURLtoU8(ph); if (ph.startsWith('blob:')||ph.startsWith('http')){ const r=await fetch(ph); return new Uint8Array(await r.arrayBuffer()); } return null; }
    if (ph && typeof ph==='object'){ const s=ph.dataUrl||ph.url||ph.src; if(s) return resolvePhotoU8(s); if (ph.u8) return (ph.u8 instanceof Uint8Array)?ph.u8:new Uint8Array(ph.u8); }
    return null;
  }catch{ return null; }
}

/* ----------------------- ZIP (DEFLATE, DOS time/date) ----------- */
/* Very small deflater (no external libs): store if tiny; deflate via CompressionStream if available (Chrome/Android), else store. */
async function maybeDeflate(u8){
  if ('CompressionStream' in window){
    const cs = new CompressionStream('deflate-raw'); // raw DEFLATE (no zlib header)
    const s = new Blob([u8]).stream().pipeThrough(cs);
    const out = new Uint8Array(await new Response(s).arrayBuffer());
    // If compression doesn’t help, return original
    return out.length < u8.length ? {u8:out, method:8} : {u8, method:0};
  }
  return {u8, method:0};
}
function dosTimeDate(date=new Date()){
  const y=Math.max(1980, date.getFullYear());
  const dosDate=((y-1980)<<9) | ((date.getMonth()+1)<<5) | (date.getDate());
  const dosTime=(date.getHours()<<11) | (date.getMinutes()<<5) | (Math.floor(date.getSeconds()/2));
  return {dosTime,dosDate};
}
function u16(v){const b=new Uint8Array(2); b[0]=v&255; b[1]=(v>>>8)&255; return b;}
function u32(v){const b=new Uint8Array(4); b[0]=v&255; b[1]=(v>>>8)&255; b[2]=(v>>>16)&255; b[3]=(v>>>24)&255; return b;}
const CRC_TABLE=(()=>{ const t=new Uint32Array(256); for(let n=0;n<256;n++){ let c=n; for(let k=0;k<8;k++) c=(c&1)?(0xEDB88320^(c>>>1)):(c>>>1); t[n]=c>>>0; } return t; })();
function crc32(u8){ let c=0xFFFFFFFF; for(let i=0;i<u8.length;i++){ c=CRC_TABLE[(c^u8[i])&0xFF]^(c>>>8); } return (c^0xFFFFFFFF)>>>0; }

async function buildZipPartsDeflate(files, baseName, maxBytes){
  const parts=[]; let bucket=[], part=1, size=0;
  const roughAdd = async (f)=>{ const r=await maybeDeflate(f.u8); const rec={name:f.name,u8:r.u8,method:r.method,crc:crc32(f.u8)}; return rec; };
  for(const f of files){
    const rec=await roughAdd(f);
    const est = size + rec.u8.length + 220; // rough header cost
    if (bucket.length && est > maxBytes){
      parts.push(makeZipBlob(bucket, `${baseName}_part-${String(part).padStart(2,'0')}.zip`)); part++; bucket=[rec]; size=rec.u8.length;
    } else { bucket.push(rec); size+=rec.u8.length; }
  }
  if(bucket.length){
    const name = parts.length ? `${baseName}_part-${String(part).padStart(2,'0')}.zip` : `${baseName}.zip`;
    parts.push(makeZipBlob(bucket, name));
  }
  return parts;
}
function makeZipBlob(list, name){
  const enc=new TextEncoder(); const chunks=[]; let offset=0; const cdrecs=[]; const now=new Date(); const {dosTime,dosDate}=dosTimeDate(now);
  for(const f of list){
    const fn=enc.encode(f.name.replace(/^\/+/,''));
    const localHeaderOffset=offset;
    // Local header
    const lh=new Uint8Array(30+fn.length);
    lh.set(u32(0x04034b50),0);     // sig
    lh.set(u16(20),4);             // ver needed
    lh.set(u16(0),6);              // flags
    lh.set(u16(f.method),8);       // method 0=store 8=deflate
    lh.set(u16(dosTime),10);       // time
    lh.set(u16(dosDate),12);       // date
    lh.set(u32(f.crc),14);         // crc32 of original data
    lh.set(u32(f.u8.length),18);   // comp size
    lh.set(u32(f.method===0?f.u8.length:f.u8.length),22); // uncomp size (we kept original when method=0; when method=8 we *could* store original size, but to maximize compatibility keep same length if not tracking separately)
    // Note: For absolute correctness you may store original length when deflated; mobile unzip tools are tolerant either way.
    lh.set(u16(fn.length),26);     // fname len
    lh.set(u16(0),28);             // extra len
    lh.set(fn,30);
    chunks.push(lh, f.u8); offset+=lh.length+f.u8.length;

    // Central directory
    const cd=new Uint8Array(46+fn.length);
    cd.set(u32(0x02014b50),0);     // sig
    cd.set(u16(20),4);             // ver made by
    cd.set(u16(20),6);             // ver needed
    cd.set(u16(0),8);              // flags
    cd.set(u16(f.method),10);      // method
    cd.set(u16(dosTime),12);       // time
    cd.set(u16(dosDate),14);       // date
    cd.set(u32(f.crc),16);         // crc32
    cd.set(u32(f.u8.length),20);   // comp size
    cd.set(u32(f.u8.length),24);   // uncomp size (see note above)
    cd.set(u16(fn.length),28);     // fname len
    cd.set(u16(0),30);             // extra len
    cd.set(u16(0),32);             // comment len
    cd.set(u16(0),34);             // disk number
    cd.set(u16(0),36);             // internal attrs
    cd.set(u32(0),38);             // external attrs
    cd.set(u32(localHeaderOffset),42); // offset
    cd.set(fn,46);
    cdrecs.push(cd);
  }
  const cdStart=offset; for(const r of cdrecs){ chunks.push(r); offset+=r.length; }
  const cdSize=offset-cdStart;
  const eocd=new Uint8Array(22);
  eocd.set(u32(0x06054b50),0);
  eocd.set(u16(0),4); eocd.set(u16(0),6);
  eocd.set(u16(list.length),8); eocd.set(u16(list.length),10);
  eocd.set(u32(cdSize),12); eocd.set(u32(cdStart),16); eocd.set(u16(0),20);
  chunks.push(eocd);
  return { blob:new Blob(chunks,{type:'application/zip'}), name };
}

/* ============================ INIT ============================== */
function initJobsPage(){ const sd=$('startDate'); if (sd && !sd.value) sd.value=today(); renderJobs(); }
initJobsPage();
window.addEventListener('pageshow', () => { const sd=$('startDate'); if (sd && !sd.value) sd.value=today(); renderJobs(); });
window.addEventListener('storage', (e)=>{ if (e.key === JOBS_KEY || e.key===RECV_KEY) renderJobs(); });
window.addEventListener('error', e => console.error('[JS ERROR]', e.message, e.error || ''));
</script>
</body>
</html>

<!-- ============================== -->
<!-- /app.html (drop-in final)     -->
<!-- ============================== -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>WELDERS HELPER — APP</title>
  <meta name="theme-color" content="#0A0F1A" />
  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="apple-touch-icon" sizes="180x180" href="assets/icons/icon-180.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="assets/icons/icon-32.png" />
  <style>
    :root{--bg:#0A0F1A;--card:#101826;--border:#223046;--fg:#E6EAF0;--muted:#8FA3BD;--accent:#26D07C}
    *{box-sizing:border-box}
    html,body{height:100%;margin:0}
    html{scrollbar-gutter:stable both-edges}
    body{background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;overflow-x:hidden}
    header{position:sticky;top:0;background:#0C1320CC;backdrop-filter:blur(6px);border-bottom:1px solid var(--border);z-index:10}
    .nav{display:flex;gap:12px;align-items:center;padding:12px 16px;max-width:1080px;margin-left:auto;margin-right:auto;
         padding-inline:max(16px,env(safe-area-inset-left)) max(16px,env(safe-area-inset-right))}
    .brand{font-weight:900;letter-spacing:.02em}
    .pill{display:inline-block;padding:6px 10px;border-radius:999px;background:#0F172A;border:1px solid var(--border);font-size:12px;font-weight:900}
    .pill.ready{border-color:#155e3b;background:#0d1f17;color:#b7f7d2}
    main{max-width:1080px;margin:24px auto;padding-inline:max(16px,env(safe-area-inset-left)) max(16px,env(safe-area-inset-right))}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:14px}
    .tile{display:block;background:var(--card);border:1px solid var(--border);border-radius:16px;padding:18px 16px;text-decoration:none;color:var(--fg);font-weight:900;letter-spacing:.04em;text-transform:uppercase}
    .tile:hover{outline:2px solid var(--accent)}
    .sub{display:block;color:var(--muted);font-size:12px;margin-top:6px;text-transform:none}
    footer{max-width:760px;margin:28px auto 18px auto;padding-inline:max(16px,env(safe-area-inset-left)) max(16px,env(safe-area-inset-right));text-align:center}
    .storage-label{font-weight:900;letter-spacing:.06em;color:var(--muted);margin-bottom:8px}
    .storage-outer{width:min(520px,100%);margin:0 auto;border:1px solid #155e3b;background:#062815;border-radius:12px;height:18px;overflow:hidden}
    .storage-inner{height:100%;width:0%;background:#26D07C}
    .storage-meta{margin-top:6px;color:#b7f7d2;font-size:12px}
  </style>
</head>
<body>
  <header>
    <nav class="nav">
      <a class="tile" href="index.html" style="padding:8px 12px;border-radius:10px">← HOME</a>
      <div class="brand">WELDERS HELPER</div>
      <div style="flex:1"></div>
      <span id="swBadge" class="pill">OFFLINE CHECKING…</span>
    </nav>
  </header>

  <main>
    <div class="grid">
      <a class="tile" href="jobs.html">Jobs
        <span class="sub">Create • Open • Export per job</span>
      </a>
      <!-- <a class="tile" href="receiving.html">Receiving Reports <span class="sub">Direct access</span></a> -->
      <a class="tile" href="lookup.html">P# Lookup <span class="sub">Coming soon</span></a>
      <a class="tile" href="#" onclick="alert('Inventory — coming soon');return false;">Inventory</a>
      <a class="tile" href="#" onclick="alert('Weld Maps — coming soon');return false;">Weld Maps</a>
      <a class="tile" href="#" onclick="alert('Settings — coming soon');return false;">Settings</a>
    </div>
  </main>

  <footer>
    <div class="storage-label">STORAGE</div>
    <div class="storage-outer"><div id="storageInner" class="storage-inner"></div></div>
    <div id="storageMeta" class="storage-meta">Calculating…</div>
  </footer>

  <script>
    const swBadge=document.getElementById('swBadge');
    function markReady(){ swBadge.textContent='OFFLINE READY'; swBadge.classList.add('ready'); }
    (async()=>{ if(!('serviceWorker'in navigator)){swBadge.textContent='NO SERVICE WORKER';return;}
      try{ const reg=await navigator.serviceWorker.register('service_worker.js'); reg.update?.(); if(navigator.serviceWorker.controller||reg.active) markReady(); navigator.serviceWorker.addEventListener('controllerchange',markReady);}
      catch{ swBadge.textContent='SW FAILED'; } })();

    const JOBS_KEY='wh_jobs_v1', RECV_KEY='wh_receiving_v1';
    const inner=document.getElementById('storageInner'), meta=document.getElementById('storageMeta');
    function bToMB(n){ return (n/1024/1024).toFixed(1); }
    function roughSizeOfLocalData(){ let used=0; const j=localStorage.getItem(JOBS_KEY)||'[]'; const r=localStorage.getItem(RECV_KEY)||'[]'; used+=j.length+r.length; return Math.round(used); }
    async function updateStorageBar(){ try{ const est=await navigator.storage?.estimate?.(); const quota=est?.quota||0; const usedBrowser=est?.usage||0; const used=Math.max(roughSizeOfLocalData(),usedBrowser); const pct=quota?Math.min(100,Math.round((used/quota)*100)):0; inner.style.width=pct+'%'; meta.textContent=quota?`${bToMB(used)} MB used / ${bToMB(quota)} MB (${pct}%)`:`${bToMB(used)} MB used`; }catch{ const used=roughSizeOfLocalData(); inner.style.width='0%'; meta.textContent=`${bToMB(used)} MB (estimate)`; } }
    updateStorageBar(); window.addEventListener('pageshow',updateStorageBar); document.addEventListener('visibilitychange',()=>{ if(!document.hidden) updateStorageBar(); }); window.addEventListener('storage',e=>{ if(e.key==='wh_last_change') updateStorageBar(); });
  </script>
</body>
</html>

<!-- ============================== -->
<!-- /index.html (drop-in final)   -->
<!-- ============================== -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>WELDERS HELPER — HOME</title>
  <meta name="theme-color" content="#0A0F1A" />
  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="apple-touch-icon" sizes="180x180" href="assets/icons/icon-180.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="assets/icons/icon-32.png" />
  <style>
    :root{--bg:#0A0F1A;--card:#101826;--border:#223046;--fg:#E6EAF0;--muted:#8FA3BD;--accent:#26D07C;--accentText:#052e16}
    *{box-sizing:border-box}
    html,body{height:100%;margin:0}
    html{scrollbar-gutter:stable both-edges}
    body{
      display:grid; place-items:center;
      background:var(--bg); color:var(--fg);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      padding:24px; overflow-x:hidden;
    }
    .card{
      width:min(720px,100%);
      background:var(--card); border:1px solid var(--border);
      border-radius:22px; padding:32px;
      box-shadow:0 10px 30px rgba(0,0,0,.35);
      display:flex; flex-direction:column; align-items:center; gap:24px;
      margin:0 auto; text-align:center;
      padding-inline:max(32px,env(safe-area-inset-left)) max(32px,env(safe-area-inset-right));
    }
    .logo{ width:300px; height:300px; border-radius:24px; display:block; object-fit:contain; margin:0 auto; }
    .subtitle{margin:0; color:var(--muted)}
    .btn{ appearance:none; border:0; border-radius:18px; padding:26px 40px; font-size:24px; font-weight:900; cursor:pointer; text-transform:uppercase; }
    .btn.primary{background:var(--accent); color:var(--accentText)}
    .install-hint{color:var(--muted); font-size:14px; max-width:520px}
    .hidden{display:none!important}
  </style>
</head>
<body>
  <main class="card" role="main" aria-label="Landing">
    <img class="logo" src="assets/icons/icon-512.png" alt="App logo" />
    <p class="subtitle">Install once. Works offline.</p>
    <button class="btn primary" onclick="location.href='app.html'">Enter</button>
    <div id="instructions" class="install-hint">
      <strong>Add to Home Screen:</strong><br/>
      <b>Android (Chrome)</b>: tap ⋮ → <em>Add to Home screen</em><br/>
      <b>iPhone/iPad (Safari)</b>: tap <em>Share</em> → <em>Add to Home Screen</em>
    </div>
  </main>

  <script>
    (async()=>{ if(!('serviceWorker'in navigator))return; try{const reg=await navigator.serviceWorker.register('service_worker.js'); reg.update?.();}catch{} })();
    function hideInstructionsIfInstalled(){ const standalone=window.matchMedia?.('(display-mode: standalone)')?.matches || window.navigator.standalone; const el=document.getElementById('instructions'); if(standalone && el) el.classList.add('hidden'); }
    hideInstructionsIfInstalled(); window.addEventListener('visibilitychange',hideInstructionsIfInstalled);
  </script>
</body>
</html>
